---
title: More figures!
subtitle: Cape vs SWA publication
author: Ruan van Mazijk
date: '`r format(Sys.time(), "%F")`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.height = 3,
  fig.width = 5
)
```

```{r setup-data, include=FALSE}
source(here::here("setup.R"))
source(here::here("data/01_import-region-polygons.R"))
source(here::here("data/02_import-floral-data.R"))
GCFR_spp <- readOGR(here::here(
  "outputs/species-turnover-and-richness/GCFR_spp_2018-08-10"
))
SWAFR_spp <- readOGR(here::here(
  "outputs/species-turnover-and-richness/SWAFR_spp_2018-08-10"
))
names(GCFR_spp)[6:8] <-
  c("HDS_richness", "mean_QDS_richness", "mean_QDS_turnover")
names(SWAFR_spp)[6:8] <-
  c("HDS_richness", "mean_QDS_richness", "mean_QDS_turnover")
GCFR_spp_data <- GCFR_spp@data %>%
  select(hdgc, HDS_richness, mean_QDS_richness, mean_QDS_turnover) %>%
  distinct()
SWAFR_spp_data <- SWAFR_spp@data %>%
  select(hdgc, HDS_richness, mean_QDS_richness, mean_QDS_turnover) %>%
  distinct()
richness_turnover_data <- as_tibble(rbind(
  cbind(region = "Cape", GCFR_spp_data),
  cbind(region = "SWA", SWAFR_spp_data)
))
richness_turnover_data %<>% mutate(
  add_residual_turnover = HDS_richness - mean_QDS_richness,
  add_mean_QDS_richness_prop = mean_QDS_richness / HDS_richness,
  add_residual_turnover_prop = add_residual_turnover / HDS_richness,
  prod_residual_turnover = HDS_richness / mean_QDS_richness
)
```

```{r setup-models, include=FALSE}
Cape_m0 <- lm(
  HDS_richness ~ 1,
  data = na.exclude(filter(richness_turnover_data, region == "Cape"))
)
Cape_m1 <- lm(
  HDS_richness ~ mean_QDS_richness,
  data = na.exclude(filter(richness_turnover_data, region == "Cape"))
)
Cape_m2 <- lm(
  HDS_richness ~ mean_QDS_richness + mean_QDS_turnover,
  data = na.exclude(filter(richness_turnover_data, region == "Cape"))
)
Cape_m3 <- lm(
  HDS_richness ~ mean_QDS_richness * mean_QDS_turnover,
  data = na.exclude(filter(richness_turnover_data, region == "Cape"))
)
SWA_m0 <- lm(
  HDS_richness ~ 1,
  data = na.exclude(filter(richness_turnover_data, region == "SWA"))
)
SWA_m1 <- lm(
  HDS_richness ~ mean_QDS_richness,
  data = na.exclude(filter(richness_turnover_data, region == "SWA"))
)
SWA_m2 <- lm(
  HDS_richness ~ mean_QDS_richness + mean_QDS_turnover,
  data = na.exclude(filter(richness_turnover_data, region == "SWA"))
)
SWA_m3 <- lm(
  HDS_richness ~ mean_QDS_richness * mean_QDS_turnover,
  data = na.exclude(filter(richness_turnover_data, region == "SWA"))
)
```

# Defining the models

I have fit the following models, separately for the Cape and SWA:

1. $HDS \ richness \sim \overline{QDS \ richness}$
2. $HDS \ richness \sim \overline{QDS \ richness} + \overline{QDS \ turnover}$
3. $HDS \ richness \sim \overline{QDS \ richness} * \overline{QDS \ turnover}$

And a null model ($\overline{HDS \ richness}$), too, for each region.

# Comparing model parameterisations nos. 0--3

I compared these models using likelihood ratio tests and $\Delta AIC$-scores.

What I find (Tables 1,2) is that there is support for there being an interaction between mean QDS richness and turnover in affecting HDS richness. Interestingly, the models with only additive effects (model parameterisation no. 2), is incredibly poorly supported.

I think, then, we should and can interpret the interaction-effects models (parameterisation no. 3), the summaries of the coefficients of which are in Table 3.

# Interpreting model parameterisation no. 3

If we imagine the HDS richness surface as a function of mean QDS richness and turnover, then Fig. 3 represents Fig. 1 with regression lines that are "slices" of the regressed HDS richness surface ("sliced" at the turnover values keyed).

From this we can see that increasing mean QDS turnover causes mean QDS richness to have a greater positive effect on HDS richness.

This makes sense to me, as it shows how QDS richness and turnover act synergistically to produce HDS richness.

What is nice to compare between Fig. 4 and 5 (Cape and SWA models, respectively), is that this synergy is strongest in SWA. I.e., Cape richness is more strongly determined by higher alpha richness.

This is complicated by how SWA has lower observed turnover values... 

But I shall leave that for a discussion with you two in person.

# Exploring the distributions of partitioned turnover and richness

## Additive definition of $\gamma$

After our meetings on Monday (2018-08-13), if we take Whittaker's additive definition of broader scale diversity,

$$
  \gamma = \alpha+ \beta
$$

Then we can define a sort of "residual" $\beta$, or turnover:

$$
  \beta_{residual} = \gamma - \alpha
$$

Alternatively, we can take Whittaker's multiplicative definition of $\gamma$,

$$
  \gamma = \alpha \times \beta
$$

Such that the residual turnover is:

$$
  \beta_{residual} = \frac{\gamma}{\alpha}
$$

Either way (we can discuss which definition is more suited to our work... See Jost 2007 Ecology 88(10)) we can explore how these metrics of the "partitioning" of HDS richness ($\approx \gamma$) into QDS richness ($\approx alpha$) and turnover ($\approx beta$), the things that come together to produce HDS richness.

Let us compare the distributions of additive-style residual turnover values between the Cape and SWA. I check for normality and homoscedasticity using Shapiro-Wilk and variance/$F$-ratio tests respectively (normal when $P_{ShapiroWilk} \geq 0.05$; equal variance when $P_{F} \geq 0.05$). If are normal and homoscedastic, a student's $t$-test was performed between the two regions' values. If data could not be normalised with a $log(x + 1)$-transformation, a Mann-Whitney $U$-test was performed.

```{r}
richness_turnover_data %$% compare_samples(
  add_residual_turnover[region == "Cape"],
  add_residual_turnover[region == "SWA"],
  alternative = "two.sided"
)
```

Now let us compare the distributions of mean QDS turnover values, raw, just for interest's sake

```{r}
richness_turnover_data %$% compare_samples(
  mean_QDS_turnover[region == "Cape"],
  mean_QDS_turnover[region == "SWA"],
  alternative = "two.sided"
)
```

If we scale additive residual turnover and mean QDS richness to be components of HDS richness,

$$
  {\beta_{residual}}_{prop} = \frac{\beta_{residual}}{\gamma} \\
  {\alpha}_{prop} = \frac{\alpha}{\gamma}
$$

These are the additive "components" of HDS richness ($\approx \gamma$).

Let's compare the distributions of these between the Cape and SWA.

```{r}
richness_turnover_data %$% 
  compare_samples(
    add_residual_turnover_prop[region == "Cape"],
    add_residual_turnover_prop[region == "SWA"],
    alternative = "two.sided"
  )
# VS
#richness_turnover_data %>%
#  filter(add_residual_turnover_prop > 0) %$% #### !!! ####
#  compare_samples(
#    add_residual_turnover_prop[region == "Cape"],
#    add_residual_turnover_prop[region == "SWA"],
#    alternative = "two.sided"
#  )
```

```{r}
richness_turnover_data %$% 
  compare_samples(
    add_mean_QDS_richness_prop[region == "Cape"],
    add_mean_QDS_richness_prop[region == "SWA"],
    alternative = "two.sided"
  )
# VS
#richness_turnover_data %>%
#  filter(add_residual_turnover_prop > 0) %$% #### !!! ####
#  compare_samples(
#    add_mean_QDS_richness_prop[region == "Cape"],
#    add_mean_QDS_richness_prop[region == "SWA"],
#    alternative = "two.sided"
#  )
```

## Multiplicative definition of $\gamma$ 

Now what about the other way of defining "residual" turnove (using Whittaker's multiplicative definition)?

$$
  \beta_{residual} = \frac{\gamma}{\alpha}
$$

I call this the "product" residual turnover, as it stems from a $\gamma$ defined as the produce of $\alpha$ and $\beta$.

```{r}
richness_turnover_data %$% compare_samples(
  prod_residual_turnover[region == "Cape"],
  prod_residual_turnover[region == "SWA"],
  alternative = "two.sided"
)
```

<!--Tables-->

```{r}
Cape_models <- 
  anova(Cape_m0, Cape_m1, Cape_m2, Cape_m3, test = "LRT") %>%
  cbind(model = c("Cape_m0", "Cape_m1", "Cape_m2", "Cape_m3"), .)
SWA_models <- 
  anova(SWA_m0, SWA_m1, SWA_m2, SWA_m3, test = "LRT") %>%
  cbind(model = c("SWA_m0", "SWA_m1", "SWA_m2", "SWA_m3"), .)
rbind(Cape_models, SWA_models) %>%
  remove_rownames() %>%
  knitr::kable(booktabs = TRUE, format = "latex", caption = "LRT of models. Each row represents the change in signficance etc. of that model relative to the one directly above it (models are nested).") %>%
  kableExtra::group_rows("Cape models", 1, 4) %>%
  kableExtra::group_rows("SWA models", 5, 8)
```

```{r}
Cape_AICs <-
  AIC(Cape_m0, Cape_m1, Cape_m2, Cape_m3) %>%
  cbind(model = rownames(.), .) %>%
  mutate(DeltaAIC = AIC - min(AIC))
SWA_AICs <-
  AIC(SWA_m0, SWA_m1, SWA_m2, SWA_m3) %>%
  cbind(model = rownames(.), .) %>%
  mutate(DeltaAIC = AIC - min(AIC)) 
rbind(Cape_AICs, SWA_AICs) %>%
  rename(k = df) %>%
  knitr::kable(booktabs = TRUE,  format = "latex", caption = "Delta AIC-scores of models.") %>%
  kableExtra::group_rows("Cape models", 1, 4) %>%
  kableExtra::group_rows("SWA models", 5, 8)
```

```{r}
rbind(tidy(Cape_m3), tidy(SWA_m3)) %>%
  knitr::kable(booktabs = TRUE, format = "latex", caption = "Cape and SWA models no. 3") %>%
  kableExtra::group_rows("Cape models", 1, 4) %>%
  kableExtra::group_rows("SWA models", 5, 8)
```

```{r}
quantile_5perc <- function(x) quantile(x, 0.05, na.rm = TRUE)
quantile_95perc <- function(x) quantile(x, 0.95, na.rm = TRUE)
median_ <- function(x) median(x, na.rm = TRUE)
richness_turnover_data %>%
  group_by(region) %>%
  select(
    add_residual_turnover, 
    add_residual_turnover_prop, add_mean_QDS_richness_prop,
    prod_residual_turnover
  ) %>%
  summarise_all(.funs = list(
    median = median_, 
    quantile_5perc = quantile_5perc, 
    quantile_95perc = quantile_95perc
  )) %>%
  gather(variable, value, -region) %>%
  mutate(
    statistic = case_when(
      str_detect(variable, "_median") ~ "median",
      str_detect(variable, "quantile_5perc") ~ "quantile_5perc",
      str_detect(variable, "quantile_95perc") ~ "quantile_95perc"
    ),
    variable = case_when(
      str_detect(variable, "_median") ~ 
        str_remove(variable, "_median"),
      str_detect(variable, "quantile_5perc") ~ 
        str_remove(variable, "_quantile_5perc"),
      str_detect(variable, "quantile_95perc") ~ 
        str_remove(variable, "_quantile_95perc")
    )
  ) %>%
  spread(statistic, value) %>%
  select(-region) %>%
  knitr::kable(format = "latex", booktabs = TRUE, caption = "...") %>%
  kableExtra::group_rows("Cape", 1, 3) %>%
  kableExtra::group_rows("SWA", 4, 6)
```

<!--Figures-->

```{r, fig.cap="Newly generated mean QDS richness vs HDS richness---now with same axis limits as Fig. 2!"}
richness_turnover_data %>%
  na.exclude() %>%
  ggplot(aes(mean_QDS_richness, HDS_richness, col = region)) +
    geom_point() +
    geom_smooth(method = lm) +
    labs(
      x = "Mean QDS richness",
      y = "HDS richness"
    ) +
    ylim(0, 3500) +
    scale_colour_manual(name = "Region", values = my_palette)
```

```{r, fig.cap="Newly generated mean QDS turnover vs HDS richness---now with same axis limits as Fig. 1!"}
richness_turnover_data %>%
  na.exclude() %>%
  ggplot(aes(mean_QDS_turnover, HDS_richness, col = region)) +
    geom_point() +
    geom_smooth(method = lm) +
    labs(
      x = "Mean QDS turnover",
      y = "HDS richness"
    ) +
    ylim(0, 3500) +
    scale_colour_manual(name = "Region", values = my_palette)
```

```{r, fig.width=12, fig.cap="Cape and SWA models with parameterisation no. 3"}
panel <- function(x, title) {
  visreg::visreg(x,
    xvar = "mean_QDS_richness",
    by = "mean_QDS_turnover",
    overlay = TRUE,
    gg = TRUE,
    breaks = c(0.70, 0.85, 1.00)
  ) +
  labs(
    x = "Mean QDS richness",
    y = "HDS richness",
    title = title
  ) +
  lims(
    x = c(0, 1500),
    y = c(0, 4250)
  ) +
  guides(
    col = guide_legend(title = "Mean QDS turnover"),
    fill = guide_legend(title = "Mean QDS turnover")
  )
}
Cape_panel <- panel(Cape_m3, "Cape") + theme(legend.position = "none")
SWA_panel <- panel(SWA_m3, "SWA")
plot_grid(Cape_panel, SWA_panel, rel_widths = c(1, 2))
```

```{r, fig.cap="Distributions of observed mean QDS turnover and richness values for both regions."}
mean_QDS_turnover_panel <- 
  ggplot(richness_turnover_data, aes(mean_QDS_turnover, fill = region)) +
  geom_histogram(position = "dodge") +
  #scale_fill_manual(name = "Region", values = c("grey67", "grey33")) +
  scale_fill_manual(name = "Region", values = my_palette) +
  theme(legend.position = "none")
mean_QDS_richness_panel <-
  ggplot(richness_turnover_data, aes(mean_QDS_richness, fill = region)) +
  geom_histogram(position = "dodge") +
  #scale_fill_manual(name = "Region", values = c("grey67", "grey33")) +
  scale_fill_manual(name = "Region", values = my_palette)
plot_grid(
  mean_QDS_turnover_panel, mean_QDS_richness_panel, 
  rel_widths = c(1, 1.5)
)
```

```{r, fig.cap="Distributions of additively defined contributions of $\\beta$ and $\\alpha$ to HDS richness."}
residual_turnover_panel <- richness_turnover_data %>%
  #filter(add_residual_turnover_prop > 0) %>% ##### !!! ######
  ggplot(aes(add_residual_turnover_prop, fill = region)) +
  geom_histogram(position = "dodge") +
  #scale_fill_manual(name = "Region", values = c("grey67", "grey33")) +
  scale_fill_manual(name = "Region", values = my_palette) +
  theme(legend.position = "none")
mean_QDS_richness_prop_panel <- richness_turnover_data %>%
  #filter(add_residual_turnover_prop > 0) %>% ##### !!! ######
  ggplot(aes(add_mean_QDS_richness_prop, fill = region)) +
  geom_histogram(position = "dodge") +
  #scale_fill_manual(name = "Region", values = c("grey67", "grey33")) +
  scale_fill_manual(name = "Region", values = my_palette)
plot_grid(
  residual_turnover_panel, mean_QDS_richness_prop_panel, 
  rel_widths = c(1, 1.5)
)
```

```{r, fig.cap="Distributions of multiplicatively defined $\\beta$ values."}
ggplot(richness_turnover_data, aes(prod_residual_turnover, fill = region)) +
  geom_histogram(position = "dodge") +
  #scale_fill_manual(name = "Region", values = c("grey67", "grey33")) +
  scale_fill_manual(name = "Region", values = my_palette)
```
