---
title    : "Analyses & results"
subtitle : "GCFR vs SWAFR manuscript"
author   : "Ruan van Mazijk"
date     : "`r Sys.Date()`"
output   : [pdf_document, html_document]
geometry : a4paper, margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo     = FALSE,
	fig.path = "figures/",
	message  = FALSE,
	warning  = FALSE
)
```

```{r load-pkgs}
# General programming
library(tidyverse)
library(here)  # for more reliable file paths
library(glue)  # better than paste()
library(magrittr)  # for %<>% & %$%

# GIS
library(raster)
library(rgdal)

# Analyses
library(canprot)  # for CLES
library(broom)  # to tidy model outputs

# Figures
library(cowplot)  # for panelling
library(ggfortify)  # for autoplot() of PCAs
```

```{r set-global-variables}
# Environmental variable names in nice order
var_names <- c(
  "Elevation",
  "MAP",
  "PDQ",
  "Surface T",
  "NDVI",
  "CEC",
  "Clay",
  "Soil C",
  "pH"
)

# Preserve clean plotting environment
op <- par()

# Global ggplot2 theme settings
theme_set(theme_bw() + theme(
  strip.background = element_blank(),
  panel.grid = element_blank()
))
```

# 1. Comparing environmental heterogeneity

```{r import-environmental-data}
data_dir <- here("data/derived-data/May-2019")
GCFR_file_names  <- glue("{data_dir}/GCFR_{var_names}_masked2.tif")
SWAFR_file_names <- glue("{data_dir}/SWAFR_{var_names}_masked2.tif")
GCFR_variables  <- stack(GCFR_file_names)
SWAFR_variables <- stack(SWAFR_file_names)
names(GCFR_variables)  <- str_replace_all(var_names, " ", "_")
names(SWAFR_variables) <- str_replace_all(var_names, " ", "_")
#GCFR_variables
#SWAFR_variables
```

```{r plot-0.05-environmental-data, eval=FALSE}
# TODO: neaten these plots up for SI(?)
par(mfrow = c(3, 3))
plot(GCFR_variables)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_variables)
par(op)
```

```{r resample-environmental-data-from-0.05-to-EDS}
EDS_template_raster <- GCFR_variables$Elevation %>%
  aggregate(fact = 5) %>%  # aggregate up to QDS
  disaggregate(fact = 2)   # disaggregate down to EDS
GCFR_variables_EDS <- resample(
  GCFR_variables, EDS_template_raster,
  method = "bilinear"
)

EDS_template_raster <- SWAFR_variables$Elevation %>%
  aggregate(fact = 5) %>%
  disaggregate(fact = 2)
SWAFR_variables_EDS <- resample(
  SWAFR_variables, EDS_template_raster,
  method = "bilinear"
)
```

```{r plot-EDS-environmental-data, eval=FALSE}
# TODO: neaten these plots up for SI(?)
par(mfrow = c(3, 3))
plot(GCFR_variables_EDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_variables_EDS)
par(op)
```

```{r generate-heterogeneity-data}
scales <- c(1, 2, 4)

GCFR_heterogeneity <- map(scales,
  ~ GCFR_variables_EDS %>%
    aggregate(fact = .x) %>%
    aggregate(fun = var)
)
names(GCFR_heterogeneity) <- c("QDS", "HDS", "DS")
GCFR_heterogeneity %<>% {c(point1 = aggregate(GCFR_variables, fun = var), .)}

SWAFR_heterogeneity <- map(scales,
  ~ SWAFR_variables_EDS %>%
    aggregate(fact = .x) %>%
    aggregate(fun = var)
)
names(SWAFR_heterogeneity) <- c("QDS", "HDS", "DS")
SWAFR_heterogeneity %<>% {c(point1 = aggregate(SWAFR_variables, fun = var), .)}
```

```{r plot-heterogeneity-data, eval=FALSE}
# TODO: neaten these plots up for SI
par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$point1)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$QDS)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$HDS)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$DS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$point1)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$QDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$HDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$DS)
par(op)
```

```{r tidy-heterogeneity-data}
# Join regions' datasets
heterogeneity <- map2(GCFR_heterogeneity, SWAFR_heterogeneity,
  ~ na.exclude(rbind(
    cbind(region = "GCFR",  as.data.frame(log10(.x))),
    cbind(region = "SWAFR", as.data.frame(log10(.y)))
  ))
)
# Scale and centre all heterogeneity values _across_ regions
heterogeneity %<>%
  map(mutate_if,
    is.numeric, scale
  ) %>%
  map(as_tibble)# %>%
  #map(set_colnames,
  #  c("region", str_replace_all(var_names, " ", "_"))
  #)
```

```{r generate-PC1-of-EH}
heterogeneity_PCAs <- map(heterogeneity,
  ~ prcomp(
    .x[, -1], 
    center = TRUE, 
    scale. = TRUE
  )
)
#map(heterogeneity_PCAs, summary)

# Force PC1 scores to be positive if all vars rotations are negative
heterogeneity_PCAs %<>% map(function(PCA) {
  if (all(PCA$rotation[, 1] <= 0)) {
    message("Multiplying this one by -1")
    PCA$rotation[, 1] %<>% multiply_by(-1)
    PCA$x[, 1]        %<>% multiply_by(-1)
  }
  PCA
})
```

```{r plot-PC1-of-EH, eval=FALSE}
# TODO: neaten this plot up for SI
plot_grid(plotlist = map2(
  .x = heterogeneity_PCAs,
  .y = heterogeneity,
  .f =
    ~ autoplot(.x, data = .y, colour = "region",
      alpha = 0.25,
      loadings       = TRUE, loadings.colour       = "black",
      loadings.label = TRUE, loadings.label.colour = "black",
      loadings.label.hjust = -0.25
    ) +
    ggtitle(unique(.y$scale)) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5)
))
```

```{r add-PC1-to-heterogeneity-data}
PC1s <- map(heterogeneity_PCAs, ~tibble(PC1 = .x$x[, 1]))
heterogeneity %<>% map2(PC1s, ~as_tibble(cbind(.x, .y)))
```

```{r CLES-analysis}
heterogeneity_for_CLES <- list(
  GCFR = heterogeneity %>%
    map(filter, region == "GCFR") %>%
    map(dplyr::select, -region),
  SWAFR = heterogeneity %>%
    map(filter, region == "SWAFR") %>%
    map(dplyr::select, -region)
)
CLES_results <- heterogeneity_for_CLES %$% map2_dfr(GCFR, SWAFR, .id = "scale",
  # For every spatial scale, ...
  ~ map2_df(.x, .y, .id = "variable",
  # ... for every variable in each region, ...
    ~ tibble(
      # ... calculate the CLES, ...
      CLES_value = CLES(.y, .x),
      # ... & run a Mann-Whitney U-test.
      U_test = wilcox.test(.x, .y, conf.int = TRUE) %>% 
        tidy() %>%
        list()
    )
  )
)
CLES_results %<>% mutate(
  variable = factor(variable, levels = var_names %>%
    str_replace_all(" ", "_") %>%
    c("PC1")
  ),
  scale = case_when(
    scale == "point1" ~ 0.10,
    scale == "QDS"    ~ 0.25,
    scale == "HDS"    ~ 0.50,
    scale == "DS"     ~ 1.00
  ),
  diff  = map_dbl(U_test, "estimate"),
  P_U   = map_dbl(U_test, "p.value"),
  U_low = map_dbl(U_test, "conf.low"),
  U_upp = map_dbl(U_test, "conf.high")
)
```

```{r fit-lms-of-CLES-vs-scale-for-each-variable}
CLES_models <- CLES_results %>%
  split(.$variable) %>%
  map(~lm(CLES_value ~ scale, .x))

# Summarise those models
CLES_model_summaries <- CLES_models %>%
  map_df(.id = "variable", tidy) %>%
  filter(term != "(Intercept)") %>%
  mutate(sig = case_when(
    p.value <= 0.05 ~ "*",
    p.value <= 0.10 ~ ".",
    TRUE            ~ " "
  )) %>%
  mutate(variable = factor(variable, levels = var_names %>%
    str_replace_all(" ", "_") %>%
    c("PC1")
  )) %>%
  mutate_if(is.numeric, round, digits = 3) %>%
  dplyr::select(variable, estimate, p.value, sig)
# Print table
knitr::kable(CLES_model_summaries,
  caption = paste(
    "Slopes of _CLES_ against ..."  # TODO
  ),
  col.names = c("Variable", "Slope", "_P_", " "),
  align = "lrrc"
)
```

```{r plot-heterogeneity-distributions, eval=FALSE}
# TODO: neaten this plot up for SI(?)
heterogeneity %>%  #heterogeneity_df %>%
  bind_rows(.id = "scale") %>%
  gather(
    variable, heterogeneity_value,
    -region, -scale#, -lon, -lat
  ) %>%
  mutate(variable = factor(variable, levels = var_names %>%
    str_replace_all(" ", "_") %>%
    c("PC1")
  )) %>%
  ggplot(aes(as.factor(scale), heterogeneity_value, fill = region)) +
    geom_boxplot() +
    facet_wrap(~variable, nrow = 2)
```

```{r plot-CLES, fig.cap="Simple linear regressions of the common language effect size (_CLES_) ..."}
# Neaten variable labels to include panel letters
CLES_results %<>% mutate(
  variable = variable %>%
    as.character() %>%
    str_replace_all("_", " "),
  letters = rep(letters[1:10], 4),
  label = glue("({letters}) {variable}")
)
  
# Create empty panels
empty_plots <- ggplot(CLES_results, aes(scale, CLES_value)) +
  geom_hline(yintercept = 0.5, lty = "dashed") +
  facet_wrap(~label, nrow = 2) +
  scale_x_continuous(
    name   = "Scale (ยบ)",
    breaks = c(0.10, 0.25, 0.50, 1.00)
  ) +
  scale_y_continuous(
    name   = bquote(italic("CLES")~~~"(GCFR > SWAFR)") 
  ) +
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 90, vjust = 0.5),
    axis.text.y     = element_text(angle = 90, hjust = 0.5),
    strip.text.x    = element_text(hjust = 0)
  )
# Create dataset without data for NS regressions (above),
# so that geom_smooth() can't plot for those variables
sig_fits <- CLES_model_summaries %>%
  filter(sig != " ") %>%
  pull(variable) %>%
  str_replace_all("_", " ")
CLES_results_sans_NS <- CLES_results %>% mutate(
  CLES_value = ifelse(variable %in% sig_fits, CLES_value, NA)
)
# Add fits to empty plots
CLES_plots <- empty_plots +
  geom_smooth(
    data    = CLES_results_sans_NS,
    mapping = aes(group = label),
    method  = lm,
    se      = FALSE,
    colour  = "grey50"
  ) +
  # Plot full dataset on top of fits for clarity
  geom_point(data = CLES_results, aes(shape = P_U < 0.05), size = 2) +
  scale_shape_manual(values = c(1, 19))

CLES_plots
```

```{r plot-U-test-estimated-diffs, eval=FALSE}
# TODO: neaten this plot of SI
ggplot(CLES_results) +
  aes(scale, diff, group = variable) +
  geom_hline(yintercept = 0.0, lty = "dashed") +
  geom_line() +
  geom_errorbar(aes(ymin = U_low, ymax = U_upp), width = 0) +
  geom_point(aes(shape = P_U < 0.05)) +
  scale_shape_manual(name = bquote(italic("P"["U"]) < 0.05), values = c(1, 19))  +
  facet_wrap(~variable, nrow = 2)
```

# 2. Comparing species richness

```{r import-region-polygons, results="hide"}
GCFR_border  <- readOGR(here("data/derived-data/borders/GCFR_border"))
SWAFR_border <- readOGR(here("data/derived-data/borders/SWBP_Mike-Cramer"))

GCFR_box  <- readOGR(here("data/derived-data/borders/GCFR_box"))
SWAFR_box <- readOGR(here("data/derived-data/borders/SWAFR_box"))

# Import EDS polygons
ZA_EDS <- readOGR(here("data/raw-data/QDGC/qdgc_zaf"), layer = "qdgc_03_zaf")
AU_EDS <- readOGR(here("data/raw-data/QDGC/qdgc_aus"), layer = "qdgc_03_aus")

# Crop to regions
GCFR_EDS  <- crop(ZA_EDS, GCFR_box)
SWAFR_EDS <- crop(AU_EDS, SWAFR_box)

# Get DS, HDS, QDS codes from EDS codes
Larsen_grid <- rbind(GCFR_EDS, SWAFR_EDS)
Larsen_grid$edgc <- Larsen_grid$qdgc
Larsen_grid$qdgc <- str_remove(Larsen_grid$edgc, ".$")
Larsen_grid$hdgc <- str_remove(Larsen_grid$qdgc, ".$")
Larsen_grid$dgc  <- str_remove(Larsen_grid$hdgc, ".$")
```

```{r collate-heterogeneity-into-grids}
# Include lon/lat when converting from Raster* to data.frame
raster2df <- function(r) {
  lon_lat <- xyFromCell(r, 1:ncell(r))
  colnames(lon_lat) <- c("lon", "lat")
  df <- as.data.frame(log10(r))
  df <- cbind(lon_lat, df)
  df
}
heterogeneity_w_coords <- map2(GCFR_heterogeneity, SWAFR_heterogeneity,
  ~ na.exclude(rbind(
    cbind(region = "GCFR",  raster2df(.x)),
    cbind(region = "SWAFR", raster2df(.y))
  ))
)
heterogeneity_w_coords %<>% 
  map(mutate_at,
    vars(str_replace_all(var_names, " ", "_")), scale
  ) %>%
  map(as_tibble)
heterogeneity <- map2(heterogeneity, heterogeneity_w_coords, full_join)

heterogeneity$QDS$QDS <- heterogeneity$QDS %$%
  SpatialPoints(
    coords      = data.frame(x = lon, y = lat),
    proj4string = crs(Larsen_grid)
  ) %over%
  Larsen_grid %>%
  pull(qdgc)

heterogeneity$HDS$HDS <- heterogeneity$HDS %$%
  SpatialPoints(
    coords      = data.frame(x = lon, y = lat),
    proj4string = crs(Larsen_grid)
  ) %over%
  Larsen_grid %>%
  pull(hdgc)

heterogeneity$DS$DS <- heterogeneity$DS %$%
  SpatialPoints(
    coords      = data.frame(x = lon, y = lat),
    proj4string = crs(Larsen_grid)
  ) %over%
  Larsen_grid %>%
  pull(dgc) 
```

```{r collate-richness-into-grids}
GCFR_species_occ <- read_rds(here(
  "data/derived-data/flora",
  "trimmed_GCFR_clean_flora_spdf_species"
))
SWAFR_species_occ <- read_rds(here(
  "data/derived-data/flora",
  "trimmed_SWAFR_clean_flora_spdf_species"
))
species_occ <- rbind(GCFR_species_occ, SWAFR_species_occ)

# Add grid codes to species data
species_occ$EDS <- species_occ %over%
  Larsen_grid %>%
  pull(edgc)
species_occ@data$EDS %<>% as.character()
species_occ$QDS <- str_remove(species_occ$EDS, ".$")
species_occ$HDS <- str_remove(species_occ$QDS, ".$")
species_occ$DS  <- str_remove(species_occ$HDS, ".$")

# Export final lists of species
GCFR_species_occ@data %>%
  group_by(species) %>%
  summarise(n_collections = n()) %>%
  arrange(desc(n_collections)) %>%
  write_csv(here("draft-02/manuscript_ver3/GCFR-species.csv"))
SWAFR_species_occ@data %>%
  group_by(species) %>%
  summarise(n_collections = n()) %>%
  arrange(desc(n_collections)) %>%
  write_csv(here("draft-02/manuscript_ver3/SWAFR-species.csv"))

# Flag species w/ < 5 collections total in each region
GCFR_bad_species <-
  read_csv(here("draft-02/manuscript_ver3/GCFR-species.csv")) %>%
  filter(n_collections < 5) %>%
  pull(species)
SWAFR_bad_species <-
  read_csv(here("draft-02/manuscript_ver3/SWAFR-species.csv")) %>%
  filter(n_collections < 5) %>%
  pull(species)
# Filter them out
species_occ_data <- species_occ@data %>%
  filter(!(species %in% c(GCFR_bad_species, SWAFR_bad_species)))

# Collate richness measures at each scale
QDS_richness <- species_occ_data %>%
  group_by(QDS) %>%
  summarise(
    n_EDS         = length(unique(EDS)),
    n_collections = length(species), 
    QDS_richness  = length(unique(species))
  )
mean_QDS_richness <- QDS_richness %>%
  mutate(HDS = str_remove(QDS, ".$")) %>%
  group_by(HDS) %>%
  summarise(
    mean_QDS_richness = mean(QDS_richness)
  )
HDS_richness <- species_occ_data %>%
  group_by(HDS) %>%
  summarise(
    n_QDS         = length(unique(QDS)),
    n_collections = length(species),
    HDS_richness  = length(unique(species))
  ) %>%
  full_join(mean_QDS_richness)
mean_HDS_richness <- HDS_richness %>%
  mutate(DS = str_remove(HDS, ".$")) %>%
  group_by(DS) %>%
  summarise(
    mean_HDS_richness = mean(HDS_richness)
  )
DS_richness <- species_occ_data %>%
  group_by(DS) %>%
  summarise(
    n_HDS         = length(unique(HDS)),
    n_collections = length(species),
    DS_richness   = length(unique(species))
  ) %>%
  full_join(mean_HDS_richness)
```

```{r collate-gridded-heterogeneity-and-richness}
data <- heterogeneity[-1]  # can't use 0.10x0.10 for richness data
data$QDS %<>%
  full_join(QDS_richness) %>%
  na.exclude() %>%
  filter(n_EDS == 4)
data$HDS %<>%
  full_join(HDS_richness) %>%
  na.exclude() %>%
  filter(n_QDS == 4) %>%
  mutate(
    QDS_turnover      = HDS_richness - mean_QDS_richness,
    QDS_turnover_prop = QDS_turnover / HDS_richness
  )
data$DS %<>%
  full_join(DS_richness) %>%
  na.exclude() %>%
  filter(n_HDS == 4) %>%
  mutate(
    HDS_turnover      = DS_richness - mean_HDS_richness,
    HDS_turnover_prop = HDS_turnover/DS_richness,
  )
```

```{r partition-plots, eval=FALSE}
ggplot(data$HDS, aes(mean_QDS_richness, QDS_turnover, colour = region)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point()
ggplot(data$DS, aes(mean_HDS_richness, HDS_turnover, colour = region)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point()
```

```{r richness-distributions, eval=FALSE}
ggplot(data$QDS, aes(QDS_richness, fill = region)) +
  geom_histogram(bins = 30, position = "dodge")

ggplot(data$HDS, aes(HDS_richness, fill = region)) +
  geom_histogram(bins = 20, position = "dodge")
ggplot(data$HDS, aes(QDS_turnover_prop, fill = region)) +
  geom_histogram(bins = 20, position = "dodge")

ggplot(data$DS, aes(DS_richness, fill = region)) +
  geom_histogram(bins = 10, position = "dodge")
ggplot(data$DS, aes(HDS_turnover_prop, fill = region)) +
  geom_histogram(bins = 10, position = "dodge")
```

```{r wilcox-tests-of-richness, eval=FALSE}
wilcox.test(QDS_richness      ~ region, data$QDS)
wilcox.test(HDS_richness      ~ region, data$HDS)
wilcox.test(DS_richness       ~ region, data$DS)
wilcox.test(QDS_turnover_prop ~ region, data$HDS)
wilcox.test(HDS_turnover_prop ~ region, data$DS)
```

```{r maps, eval=FALSE}
ggplot(data$QDS, aes(lon, lat, colour = QDS_richness)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = HDS_richness)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = DS_richness)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()

ggplot(data$QDS, aes(lon, lat, colour = PC1)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = PC1)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = PC1)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()

ggplot(data$QDS, aes(lon, lat, colour = PC1_residual)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = PC1_residual)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = PC1_residual)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
```

# 3. Environmental heterogeneity as an explanation of species richness

## 3.1. Univariate models

```{r fit-PC1-models, results="hide"}
# QDS-richness:
m1 <- lm(      QDS_richness  ~ PC1, data$QDS)
m2 <- lm(  log(QDS_richness) ~ PC1, data$QDS)
m3 <- lm(log10(QDS_richness) ~ PC1, data$QDS)
AIC(m1, m2, m3) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 (log10)
m4 <- lm(log10(QDS_richness) ~ PC1 + region, data$QDS)
m5 <- lm(log10(QDS_richness) ~ PC1 * region, data$QDS)
AIC(m3, m4, m5) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 still (heterogeneity main effect only)
summary(m3)  # R^2 = 0.07619
# Store residuals in master dataset for use in maps below
data$QDS$PC1_residual <- m3$residuals

# HDS-richness:
m1 <- lm(      HDS_richness  ~ PC1, data$HDS)
m2 <- lm(  log(HDS_richness) ~ PC1, data$HDS)
m3 <- lm(log10(HDS_richness) ~ PC1, data$HDS)
AIC(m1, m2, m3) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 (log10)
m4 <- lm(log10(HDS_richness) ~ PC1 + region, data$HDS)
m5 <- lm(log10(HDS_richness) ~ PC1 * region, data$HDS)
AIC(m3, m4, m5) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 (heterogeneity main effect only)
summary(m3)  # R^2 = 0.1024
# Store residuals in master dataset for use in maps below
data$HDS$PC1_residual <- m3$residuals

# DS-richness:
m1 <- lm(      DS_richness  ~ PC1, data$DS)
m2 <- lm(  log(DS_richness) ~ PC1, data$DS)
m3 <- lm(log10(DS_richness) ~ PC1, data$DS)
AIC(m1, m2, m3) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 (log10)
m4 <- lm(log10(DS_richness) ~ PC1 + region, data$DS)
m5 <- lm(log10(DS_richness) ~ PC1 * region, data$DS)
AIC(m3, m4, m5) %>%
  mutate(delta_AIC  = AIC - min(AIC))
# Choose m3 (heterogeneity main effect only)
summary(m3)  # R^2 = 0.3473
# Store residuals in master dataset for use in maps below
data$DS$PC1_residual <- m3$residuals
```

```{r plot-PC1-models, fig.cap="..."}
data_for_PC1_plots <- as_tibble(rbind(
  cbind(scale = "QDS", data %$%
    QDS %>%
    dplyr::select(region, QDS_richness, PC1) %>%
    rename(richness = QDS_richness)
  ),
  cbind(scale = "HDS", data %$%
    HDS %>%
    dplyr::select(region, HDS_richness, PC1) %>%
    rename(richness = HDS_richness)
  ),
  cbind(scale = "DS", data %$%
    DS %>%
    dplyr::select(region, DS_richness, PC1) %>%
    rename(richness = DS_richness)
  )
))
data_for_PC1_plots %<>%
  mutate(scale =
    case_when(
      scale == "QDS" ~ "(a) QDS",
      scale == "HDS" ~ "(b) HDS",
      scale == "DS"  ~ "(c) DS" 
    ) %>%
    factor(levels = c(
      "(a) QDS",
      "(b) HDS",
      "(c) DS" 
    ))
  )
translucent_white <- rgb(1, 1, 1, 0.5)
ggplot(data_for_PC1_plots, aes(PC1, richness)) +
  geom_smooth(method = lm, colour = "black") +
  geom_point(aes(fill = region), shape = 21, colour = "black") +
  ylab(bquote(italic("S"))) +
  scale_y_log10() +
  scale_fill_manual(name = "Region", values = c("black", translucent_white)) +
  facet_grid(~scale, scales = "free_x") +
  theme(
    legend.position   = c(0.9, 0.2), 
    legend.background = element_rect(fill = NA),
    axis.text.y       = element_text(angle = 90, hjust = 0.5),
    strip.text        = element_text(hjust = 0)
  )
```

```{r}
knitr::opts_chunk$set(eval = FALSE)
```

```{r fit-univariate-models}
predictor_names <- c(str_replace_all(var_names, " ", "_"), "PC1")

models_non_region <- map(predictor_names,
  ~lm(paste("log10(QDS_richness) ~", .x), data$QDS)
)
names(models_non_region) <- predictor_names
models_add_region <- map(predictor_names,
  ~lm(paste("log10(QDS_richness) ~", .x, "+ region"), data$QDS)
)
names(models_add_region) <- predictor_names
models_int_region <- map(predictor_names,
  ~lm(paste("log10(QDS_richness) ~", .x, "* region"), data$QDS)
)
names(models_int_region) <- predictor_names
knitr::kable(pmap_dfr(
  .l  = list(models_non_region, models_add_region, models_int_region),
  .id = "variable",
  .f  = ~ AIC(..1, ..2, ..3) %>%
    mutate(
      model_rank = 1:3,
      model_type = c(" ", "+", "x")[model_rank],
      delta_AIC  = AIC - min(AIC),
      best_model = (model_rank == min(model_rank[delta_AIC < 2]))
    ) %>%
    filter(best_model) %>%
    dplyr::select(-df, -AIC, -model_rank, -best_model)
))

models_non_region <- map(predictor_names,
  ~lm(paste("log10(HDS_richness) ~", .x), data$HDS)
)
names(models_non_region) <- predictor_names
models_add_region <- map(predictor_names,
  ~lm(paste("log10(HDS_richness) ~", .x, "+ region"), data$HDS)
)
names(models_add_region) <- predictor_names
models_int_region <- map(predictor_names,
  ~lm(paste("log10(HDS_richness) ~", .x, "* region"), data$HDS)
)
names(models_int_region) <- predictor_names
pmap_dfr(
  .l  = list(models_non_region, models_add_region, models_int_region),
  .id = "variable",
  .f  = ~ AIC(..1, ..2, ..3) %>%
    mutate(
      model_rank = 1:3,
      model_type = c(" ", "+", "x")[model_rank],
      delta_AIC  = AIC - min(AIC),
      best_model = (model_rank == min(model_rank[delta_AIC < 2]))
    ) %>%
    filter(best_model) %>%
    dplyr::select(-df, -AIC, -model_rank, -best_model)
)

models_non_region <- map(predictor_names,
  ~lm(glue("log10(DS_richness) ~", .x), data$DS)
)
names(models_non_region) <- predictor_names
models_add_region <- map(predictor_names,
  ~lm(paste("log10(DS_richness) ~", .x, "+ region"), data$DS)
)
names(models_add_region) <- predictor_names
models_int_region <- map(predictor_names,
  ~lm(paste("log10(DS_richness) ~", .x, "* region"), data$DS)
)
names(models_int_region) <- predictor_names
pmap_dfr(
  .l  = list(models_non_region, models_add_region, models_int_region),
  .id = "variable",
  .f  = ~ AIC(..1, ..2, ..3) %>%
    mutate(
      model_rank = 1:3,
      model_type = c(" ", "+", "x")[model_rank],
      delta_AIC  = AIC - min(AIC),
      best_model = (model_rank == min(model_rank[delta_AIC < 2]))
    ) %>%
    filter(best_model) %>%
    dplyr::select(-df, -AIC, -model_rank, -best_model)
)
```

## 3.2. Multivariate models

```{r fit-multivariate-models}
data$QDS %<>% mutate(log10_QDS_richness = log10(QDS_richness))
data$HDS %<>% mutate(log10_HDS_richness = log10(HDS_richness))
data$DS  %<>% mutate(log10_DS_richness  = log10(DS_richness))

full_formula <- predictor_names[predictor_names != "PC1"] %>%
  {c(., paste(., "* region"))} %>%
  paste(collapse = " + ")

m_QDS_richness1 <- lm(glue("QDS_richness       ~ {full_formula}"), data$QDS)
m_QDS_richness  <- lm(glue("log10_QDS_richness ~ {full_formula}"), data$QDS)
AIC(m_QDS_richness1, m_QDS_richness)

m_HDS_richness1 <- lm(glue("HDS_richness       ~ {full_formula}"), data$HDS)
m_HDS_richness  <- lm(glue("log10_HDS_richness ~ {full_formula}"), data$HDS)
AIC(m_HDS_richness1, m_HDS_richness)

m_DS_richness1 <- lm(glue("DS_richness        ~ {full_formula}"),  data$DS)
m_DS_richness  <- lm(glue("log10_DS_richness  ~ {full_formula}"),  data$DS)
AIC(m_DS_richness1, m_DS_richness)

m_QDS_richness %<>% step(direction = "backward", trace = 0)
m_HDS_richness %<>% step(direction = "backward", trace = 0)
m_DS_richness  %<>% step(direction = "backward", trace = 0)
```

```{r reparamaterise-models}
# Reparameterise models to {*}:regionGCFR & {*}:regionSWAFR
# a.o.t. {*}*region, so that the figure of the effects actually represents
# each region, not the baseline (GCFR) and "relative SWAFR"
# (and that would cause inconsistencies too when their is no interaction with
# region term for a roughness variable).
reparameterise <- function(m) {
  response <- colnames(m$model)[[1]]
  dataset <- data %$% {
    if      (response == "log10_QDS_richness") QDS
    else if (response == "log10_HDS_richness") HDS
    else if (response == "log10_DS_richness")  DS
  }
  preds_w_interactions <- m %$%
    coefficients %>%
    names() %>%
    magrittr::extract(str_which(., ":regionSWAFR"))
  reparameterisation <- preds_w_interactions %<>%
    str_remove(":regionSWAFR") %>%
    {glue("-{.}")} %>%
    paste(collapse = " ")
  update(m,
    formula = glue(". ~ . {reparameterisation}"),
    data    = dataset
  )
}
# Test:
#   a <- m_HDS_richness
#   b <- reparameterise(m_HDS_richness)
#   AIC(a, b) # same model! :)
m_QDS_richness %<>% reparameterise()
m_HDS_richness %<>% reparameterise()
m_DS_richness  %<>% reparameterise()
```

```{r summarise-models}
models <- list(
  QDS_richness = m_QDS_richness,
  HDS_richness = m_HDS_richness,
  DS_richness  = m_DS_richness
)
models_summary <- models %>%
  map_df(.id = "response", tidy, conf.int = TRUE) %>%
  dplyr::select(-std.error, -statistic) %>%
  filter(term != "(Intercept)")

models_R2 <- models %>%
  map_df(.id = "response", glance) %>%
  dplyr::select(response, adj.r.squared)

models_summary %<>% full_join(models_R2)

glance(m_QDS_richness)
glance(m_HDS_richness)
glance(m_DS_richness)

data$QDS$multivariate_residual <- m_QDS_richness$residuals
data$HDS$multivariate_residual <- m_HDS_richness$residuals
data$DS$multivariate_residual  <- m_DS_richness$residuals
```

```{r more-maps}
ggplot(data$QDS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
```

```{r plot-multivariate-models}
models_R2adjs <- models_summary %>%
  group_by(response) %>%
  summarise(adj.r.squared = adj.r.squared %>%
    unique() %>%
    round(digits = 2)
  )
models_summary_for_plot <- models_summary %>%
  mutate(
    response = case_when(
      response == "QDS_richness" ~ "(a)~QDS~~(italic(R)[adj]^2=='0.20')",
      response == "HDS_richness" ~ "(b)~HDS~~(italic(R)[adj]^2=='0.21')",
      response == "DS_richness"  ~ "(c)~DS~~(italic(R)[adj]^2=='0.78')"
    ),
    region = 
      case_when(
        str_detect(term, "regionSWAFR") ~ "SWAFR", 
        str_detect(term, "regionGCFR")  ~ "GCFR",
        TRUE                            ~ "Main effect only"
      ) %>%
      factor(levels = c("Main effect only", "GCFR", "SWAFR")),
    term = term %>%
      str_replace_all("\\.", " ") %>%
      str_remove_all("regionSWAFR:") %>%
      str_remove_all("regionGCFR:") %>%
      str_replace_all("regionSWAFR", "SWAFR") %>%
      factor(levels = c(str_replace_all(var_names, " ", "_"), "SWAFR")),
    sig = case_when(
      p.value < 0.005 ~ "< 0.005",
      p.value < 0.05  ~ "< 0.05",
      TRUE            ~ "NS"
    )
  )
ggplot(models_summary_for_plot) +
  aes(
    term, estimate,
    fill = region, group = region, shape = region,
    alpha = sig
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey75") +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.25),
    width = 0
  ) +
  geom_point(position = position_dodge(width = 0.25)) +
  labs(
    x = "Predictor",
    y = bquote(
      "Effect"~~
      "(log"["10"]*italic("S")*")"
    )
  ) +
  scale_fill_manual(values = c(NA, "black", "white")) +
  scale_shape_manual(values = c(4, 21, 21)) +
  scale_alpha_manual(name = bquote(italic("P")["Effect"]),
                     values = c(1, 0.75, 0.25)) +#c(0.25, 1)) +
  facet_wrap(~response, nrow = 3, scales = "free_y", labeller = label_parsed) +
  guides(
    fill = FALSE,
    shape = guide_legend(
      title = "Effect type",
      override.aes = list(fill = c(NA, "black", "white"))
    )#, 
    #alpha = FALSE
  ) +
  theme(
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5),
    #axis.text.y  = element_text(angle = 90, hjust = 0.5),
    strip.text.x = element_text(angle =  0, hjust = 0)
  )
```
