---
title    : "Analyses & results"
subtitle : "GCFR vs SWAFR manuscript"
author   : "Ruan van Mazijk"
date     : "`r Sys.Date()`"
output   : [pdf_document, word_document]
geometry : a4paper, margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo     = FALSE,
	fig.path = "figures/",
	message  = FALSE,
	warning  = FALSE
)
options(knitr.kable.NA = '')
library(here)
source(here("draft-02/manuscript_ver3/R/setup.R"))
```

# 1. Comparing environmental heterogeneity

```{r generate-heterogeneity-data, results="hide"}
source(here("draft-02/manuscript_ver3/R/generate-heterogeneity-data.R"))
```

```{r plot-0.05-environmental-data, eval=FALSE}
# TODO: neaten these plots up for SI(?)
par(mfrow = c(3, 3))
plot(GCFR_variables)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_variables)
par(op)
```

```{r plot-EDS-environmental-data, eval=FALSE}
# TODO: neaten these plots up for SI(?)
par(mfrow = c(3, 3))
plot(GCFR_variables_EDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_variables_EDS)
par(op)
```

```{r plot-heterogeneity-data, eval=FALSE}
# TODO: neaten these plots up for SI
par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$point1)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$QDS)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$HDS)
par(op)

par(mfrow = c(3, 3))
plot(GCFR_heterogeneity$DS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$point1)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$QDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$HDS)
par(op)

par(mfrow = c(3, 3))
plot(SWAFR_heterogeneity$DS)
par(op)
```

```{r plot-PC1-of-EH, eval=FALSE}
# TODO: neaten this plot up for SI
heterogeneity_PCAs %>%
  map2(heterogeneity,
    ~ autoplot(.x, data = .y, colour = "region",
      alpha = 0.25,
      loadings       = TRUE, loadings.colour       = "black",
      loadings.label = TRUE, loadings.label.colour = "black",
      loadings.label.hjust = -0.25
    ) +
    ggtitle(unique(.y$scale)) +
    geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5)
  ) %>%
  {plot_grid(plotlist = .)}
```

```{r compare-environmental-heterogeneity, results="hide"}
source(here("draft-02/manuscript_ver3/R/compare-environmental-heterogeneity.R"))
```

```{r plot-CLES, fig.cap="The common language effect size (_CLES_) of (a--i) various forms of environmental heterogeneity (log~10~-transformed) and (j) the major axis thereof (PC1) in the GCFR and SWAFR. The _CLES_ here is treated as the effect of GCFR relative to SWAFR values. Filled points represent comparisons where the GCFR and SWAFR significantly differed in heterogeneity (_P_ โค 0.05, Mann-Whitney U-tests), while unfilled points represent those that were not significant (_P_ > 0.05). Following simple linear regressions of CLES against scale, negative relationships (depicted by lines) were found for MAP (slope = -0.224, P = 0.028) and PC1 (slope = -0.076, P = 0.059). Abbreviations are as in Table 1."}
# Neaten variable labels to include panel letters
CLES_results %<>% mutate(
  variable = variable %>%
    as.character() %>%
    str_replace_all("_", " "),
  letters = rep(letters[1:10], 4),
  label = glue("({letters}) {variable}")
)
  
# Create empty panels
empty_plots <- ggplot(CLES_results, aes(scale, CLES_value)) +
  geom_hline(yintercept = 0.5, lty = "dashed") +
  facet_wrap(~label, nrow = 2) +
  scale_x_continuous(
    name   = "Scale (ยบ)",
    breaks = c(0.10, 0.25, 0.50, 1.00)
  ) +
  scale_y_continuous(
    name   = bquote(italic("CLES")~~~"(GCFR > SWAFR)") 
  ) +
  theme(
    legend.position = "none",
    axis.text.x     = element_text(angle = 90, vjust = 0.5),
    axis.text.y     = element_text(angle = 90, hjust = 0.5),
    strip.text.x    = element_text(hjust = 0)
  )
# Create dataset without data for NS regressions (above),
# so that geom_smooth() can't plot for those variables
sig_fits <- CLES_model_summaries %>%
  filter(sig != " ") %>%
  pull(variable) %>%
  str_replace_all("_", " ")
CLES_results_sans_NS <- CLES_results %>% mutate(
  CLES_value = ifelse(variable %in% sig_fits, CLES_value, NA)
)
# Add fits to empty plots
CLES_plots <- empty_plots +
  geom_smooth(
    data    = CLES_results_sans_NS,
    mapping = aes(group = label),
    method  = lm,
    se      = FALSE,
    colour  = "grey50"
  ) +
  # Plot full dataset on top of fits for clarity
  geom_point(data = CLES_results, aes(shape = P_U < 0.05), size = 2) +
  scale_shape_manual(values = c(1, 19))

CLES_plots
```

```{r plot-U-test-estimated-diffs, eval=FALSE}
# TODO: neaten this plot of SI
ggplot(CLES_results) +
  aes(scale, diff, group = variable) +
  geom_hline(yintercept = 0.0, lty = "dashed") +
  geom_line() +
  geom_errorbar(aes(ymin = U_low, ymax = U_upp), width = 0) +
  geom_point(aes(shape = P_U < 0.05)) +
  scale_shape_manual(name = bquote(italic("P"["U"]) < 0.05), values = c(1, 19))  +
  facet_wrap(~variable, nrow = 2)
```

```{r plot-heterogeneity-distributions, eval=FALSE}
# TODO: neaten this plot up for SI(?)
heterogeneity %>%  #heterogeneity_df %>%
  bind_rows(.id = "scale") %>%
  gather(
    variable, heterogeneity_value,
    -region, -scale#, -lon, -lat
  ) %>%
  mutate(variable = factor(variable, levels = var_names %>%
    str_replace_all(" ", "_") %>%
    c("PC1")
  )) %>%
  ggplot(aes(as.factor(scale), heterogeneity_value, fill = region)) +
    geom_boxplot() +
    facet_wrap(~variable, nrow = 2)
```

# 2. Comparing species richness

```{r compare-species-richness, results="hide"}
source(here("draft-02/manuscript_ver3/R/compare-species-richness.R"))
```

```{r explore-collection-effort, eval=FALSE}
ggplot(data$QDS, aes(QDS_richness, n_collections, colour = region)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()
ggplot(data$HDS, aes(HDS_richness, n_collections, colour = region)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()
ggplot(data$DS, aes(DS_richness, n_collections, colour = region)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()

ggplot(data$QDS) +
  aes(n_collections, n_collections/QDS_richness, colour = region) +
  geom_smooth(method = lm) +
  geom_point() +
  labs(
    x = "No. collections in QDS", 
    y = "No. collections per species in QDS"
  ) +
  scale_x_log10() +
  scale_y_log10()
ggplot(data$QDS) +
  aes(QDS_richness, n_collections*QDS_richness, colour = region) +
  geom_point()

ggplot(data$HDS) +
  aes(n_collections, HDS_richness, colour = region) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  lims(x = c(0, 2e4), y = c(0, 2e4))

size_of_choice <- function(n = 100) {
  d <- data.frame(x = 1:n)
  d$y <- choose(n, d$x)
  plot(y ~ x, d,type = "l")
}
size_of_choice()

1:nrow(data$HDS) %>%
  map_dfr(.id = "sample_size", ~sample_n(data$HDS, .x)) %>%
  group_by(region, sample_size) %>%
  summarise(HDS_richness = mean(HDS_richness)) %>%
  ungroup() %>%
  mutate(sample_size = as.numeric(as.character(sample_size))) %>%
  ggplot(aes(sample_size, HDS_richness, colour = region)) +
    geom_point()

ggplot(data$QDS) +
  aes(n_collections, QDS_richness/n_collections, colour = region) +
  geom_point() +
  labs(
    x = "No. collections in QDS", 
    y = "No. species per collection in QDS"
  ) +
  scale_x_log10()

ggplot(data$HDS) +
  aes(n_collections, HDS_richness/n_collections, colour = region) +
  geom_point() +
  labs(
    x = "No. collections in HDS", 
    y = "No. species per collection in HDS"
  ) +
  scale_x_log10()

ggplot(data$DS) +
  aes(n_collections, DS_richness/n_collections, colour = region) +
  geom_point() +
  labs(
    x = "No. collections in DS", 
    y = "No. species per collection in DS"
  ) +
  scale_x_log10()

ggplot(data$QDS, aes(QDS_richness/n_collections, fill = region)) +
  geom_histogram(position = "dodge")
ggplot(data$HDS, aes(HDS_richness/n_collections, fill = region)) +
  geom_histogram(position = "dodge")
ggplot(data$DS, aes(DS_richness/n_collections, fill = region)) +
  geom_histogram(position = "dodge")

data %$%
  HDS %>%
  mutate(QDS_turnover_std =
    ((HDS_richness/n_collections) - (mean_QDS_richness/n_collections)) #/
    #(HDS_richness/n_collections)
  ) %>%
  ggplot(aes(QDS_turnover_std, fill = region)) +
    geom_histogram(position = "dodge")

ggplot(data$QDS, aes(lon, lat, colour = n_collections)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = n_collections)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = n_collections)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
```

```{r plot-richness-distributions-and-partitions, fig.width=7, fig.height=6, fig.cap="Distributions of (a) QDS- and (b) HDS-scale vascular plant species richness in the GCFR and SWAFR. (c) Scatter plot of mean QDS-scale richness ($\\overline{S}$~QDS~) and turnover (_T_~QDS~; Equation 1) with contour lines denoting the _S_~HDS~ that arises as their sum. (d) The distribution of the turnover partition of _S_~HDS~ (_T_~QDS~; in c) expressed as a proportion (_T_~QDS~ / $\\overline{S}$~HDS~)."}
data_for_plot <- data %$%
  rbind(
    QDS %>%
      dplyr::select(region, QDS_richness) %>%
      rename(richness = QDS_richness) %>%
      add_column(scale = "QDS", turnover_prop = NA),
    HDS %>%
      dplyr::select(region, HDS_richness, QDS_turnover_prop) %>%
      rename(richness = HDS_richness, turnover_prop = QDS_turnover_prop) %>%
      add_column(scale = "HDS"),
    DS %>%
      dplyr::select(region, DS_richness, HDS_turnover_prop) %>%
      rename(richness = DS_richness, turnover_prop = HDS_turnover_prop) %>%
      add_column(scale = "DS")
  ) %>%
  as_tibble() %>%
  gather(metric, metric_value, richness, turnover_prop) %>%
  unite(metric_scale, scale, metric) %>%
  na.exclude()

x_axis_labels <- list(
  QDS_richness      = bquote(italic("S")["QDS"]),
  HDS_richness      = bquote(italic("S")["HDS"]),
  HDS_turnover_prop = bquote(italic("T")["QDS"]/bar(italic("S"))["QDS"]),
  DS_richness       = bquote(italic("S")["DS"]),
  DS_turnover_prop  = bquote(italic("T")["HDS"]/bar(italic("S"))["HDS"])
)
hist_plots <- map(unique(data_for_plot$metric_scale),
  ~ data_for_plot %>%
    filter(metric_scale == .x) %>%
    ggplot(aes(metric_value, fill = region)) +
      geom_histogram(
        bins = case_when(
          str_detect(.x, "QDS") ~ 30,
          str_detect(.x, "HDS") ~ 20,
          str_detect(.x, "DS")  ~ 10
        ),
        position = "dodge",
        colour = "black"
      ) +
      scale_fill_manual(name = "Region", values = c("black", "white")) +
      labs(
        x = x_axis_labels[[.x]],
        y = case_when(
          str_detect(.x, "QDS") ~ "No. QDS",
          str_detect(.x, "HDS") ~ "No. HDS",
          str_detect(.x, "DS")  ~ "No. DS"
        )
      ) +
      theme(
        legend.position = c(0.8, 0.8),
        axis.text.y     = element_text(angle = 90, hjust = 0.5)
      )
)
names(hist_plots) <- unique(data_for_plot$metric_scale)

plot_lim <- data %$%
  HDS %$%
  ceiling(max(c(mean_QDS_richness, QDS_turnover))) + 10
S_HDS_background <- plot_lim %>%
  {seq(from = 0, to = ., by = 10)} %>%
  {expand.grid(x = ., y = .)} %>%
  mutate(z = x + y)
S_HDS_background_plot <- ggplot(S_HDS_background) +
  lims(x = c(0, plot_lim), y = c(0, plot_lim)) +
  geom_contour(
    mapping     = aes(x, y, z = z),
    binwidth    = 500,
    colour      = "grey90",
    show.legend = TRUE
  ) +
  geom_abline(
    intercept = 0, slope = 1,
    linetype = "dashed", colour = "grey25"
  ) +
  labs(
    x = bquote(italic("T")["QDS"]),
    y = bquote(bar(italic("S"))["QDS"])
  ) +
  theme(axis.text.y = element_text(angle = 90, hjust = 0.5))

partition_plot <- S_HDS_background_plot +
  geom_point(
    data    = data$HDS,
    mapping = aes(QDS_turnover, mean_QDS_richness, fill = region),
    shape   = 21
  ) +
  scale_fill_manual(values = c("black", "white")) +
  theme(legend.position = "none")

# Add labels to S_HDS contours manually
label1500 <- bquote(italic("S")["HDS"] == 1500)
partition_plot <- partition_plot +
  geom_text(
    data = tibble(
      add_turnover      = c( 10,   10,        60,  560, 1060),
      mean_QDS_richness = c(500, 1000,      1450, 1500, 1500),
      HDS_richness      = c(500, 1000, label1500, 2000, 2500)
    ),
    mapping = aes(add_turnover, mean_QDS_richness, label = HDS_richness),
    angle = -45, vjust = -0.5, colour = "grey50", size = 2.5,
    parse = TRUE
  ) +
  # Flip partition plot to get axes to line up across panels (b/o text heights)
  coord_flip()

hist_plots[c("QDS_richness", "HDS_turnover_prop")] %<>% map(
  ~.x + theme(legend.position = "none")
)
# Plot panels
hist_plots %$% plot_grid(
  QDS_richness,   HDS_richness,
  partition_plot, HDS_turnover_prop,
  nrow = 2,
  labels = glue("({letters[1:4]})"),
  label_x = 0.125, label_y = 0.975
)
# TODO: Plot DS-scale versions for SI
```

# 3. Environmental heterogeneity as an explanation of species richness

```{r fit-models, results="hide"}
source(here("draft-02/manuscript_ver3/R/explaining-richness-w-heterogeneity.R"))
```

## 3.1. Univariate models

```{r plot-PC1-models, fig.width=7, fig.height=3, fig.cap="..."}
PC1_explained_var <- heterogeneity_PCAs[2:4] %>%
  map(summary) %>%
  map("importance") %>%
  map(~.x[2, "PC1"]) %>%
  map(multiply_by, 100) %>%
  map(round, digits = 2)

data_for_PC1_plots <- 
  rbind(
    cbind(scale = "QDS", data %$%
      QDS %>%
      dplyr::select(region, QDS_richness, PC1) %>%
      rename(richness = QDS_richness)
    ),
    cbind(scale = "HDS", data %$%
      HDS %>%
      dplyr::select(region, HDS_richness, PC1) %>%
      rename(richness = HDS_richness)
    ),
    cbind(scale = "DS", data %$%
      DS %>%
      dplyr::select(region, DS_richness, PC1) %>%
      rename(richness = DS_richness)
    )
  ) %>%
  as_tibble() %>%
  mutate(scale = case_when(
    scale == "QDS" ~ bquote("(a)~QDS~~(italic(R)^2 == '0.08')"),
    scale == "HDS" ~ bquote("(b)~HDS~~(italic(R)^2 == '0.10')"),
    scale == "DS"  ~ bquote("(c)~DS~~(italic(R)^2 == '0.35')")
  ))
translucent_white <- rgb(1, 1, 1, 0.5)
ggplot(data_for_PC1_plots, aes(PC1, richness)) +
  geom_point(aes(fill = region), shape = 21, colour = "black") +
  geom_smooth(method = lm, colour = "black") +
  ylab(bquote(italic("S"))) +
  xlab(paste0(
    "PC1 (", PC1_explained_var$QDS, "%)                              ",
    "PC1 (", PC1_explained_var$HDS, "%)                              ",
    "PC1 (", PC1_explained_var$DS,  "%)"
  )) +
  scale_y_log10() +
  scale_fill_manual(name = "Region", values = c("black", translucent_white)) +
  facet_grid(~scale, scales = "free_x", labeller = label_parsed) +
  theme(
    legend.position   = c(0.9, 0.2), 
    legend.background = element_rect(fill = NA),
    axis.text.y       = element_text(angle = 90, hjust = 0.5),
    strip.text        = element_text(hjust = 0)
  )
```

## 3.2. Multivariate models

```{r more-maps, eval=FALSE}
ggplot(data$QDS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 3) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$HDS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 5) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
ggplot(data$DS, aes(lon, lat, colour = multivariate_residual)) +
  geom_point(size = 10) +
  facet_grid(~region, scales = "free_x") +
  scale_colour_viridis_c()
```

```{r plot-multivariate-models, fig.width=7, fig.height=6, fig.cap="..."}
models_R2adjs <- models_summary %>%
  group_by(response) %>%
  summarise(adj.r.squared = adj.r.squared %>%
    unique() %>%
    round(digits = 2)
  )
models_summary_for_plot <- models_summary %>%
  mutate(
    response = case_when(
      response == "QDS_richness" ~ "(a)~QDS~~(italic(R)[adj]^2=='0.20')",
      response == "HDS_richness" ~ "(b)~HDS~~(italic(R)[adj]^2=='0.21')",
      response == "DS_richness"  ~ "(c)~DS~~(italic(R)[adj]^2=='0.78')"
    ),
    region = 
      case_when(
        str_detect(term, "regionSWAFR") ~ "SWAFR", 
        str_detect(term, "regionGCFR")  ~ "GCFR",
        TRUE                            ~ "Main effect only"
      ) %>%
      factor(levels = c("Main effect only", "GCFR", "SWAFR")),
    term = term %>%
      str_replace_all("_", " ") %>%
      str_remove_all("regionSWAFR:") %>%
      str_remove_all("regionGCFR:") %>%
      str_replace_all("regionSWAFR", "SWAFR") %>%
      factor(levels = c(var_names, "SWAFR")),
    sig = ifelse(p.value < 0.05, "< 0.05", "NS")
  )
ggplot(models_summary_for_plot) +
  aes(
    term, estimate,
    fill = region, group = region, shape = region,
    alpha = sig
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey75") +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.25),
    width = 0
  ) +
  geom_point(position = position_dodge(width = 0.25), size = 2) +
  labs(
    x = "Heterogeneity predictor",
    y = bquote(
      "Effect"~~
      "(log"["10"]*italic("S")*")"
    )
  ) +
  scale_fill_manual(values = c(NA, "black", "white")) +
  scale_shape_manual(values = c(4, 21, 21)) +
  scale_alpha_manual(values = c(1, 0.25)) +
  facet_wrap(~response, nrow = 3, scales = "free_y", labeller = label_parsed) +
  guides(
    fill = FALSE,
    shape = guide_legend(
      title = "Effect type",
      override.aes = list(fill = c(NA, "black", "white"))
    ),
    alpha = guide_legend(
      title = bquote(italic("P")["Effect"]),
      override.aes = list(alpha = c(1, 0.25), linetype = NA)
    )
  ) +
  theme(
    axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5),
    axis.text.y  = element_text(angle = 90, hjust = 0.5),
    strip.text.x = element_text(angle =  0, hjust = 0)
  )
#save.image(here("draft-02/manuscript_ver3/2019-09-03_saved-workspace.Rdata"))
```

```{r, eval=FALSE}
models_summary_for_plot %>%
  mutate(
    scale = c(0.25, 0.50, 1.00)[as.numeric(as.factor(response))],
    term_effect = paste(term, region)
  ) %>%
  ggplot() +
    aes(
      scale, estimate,
      fill = region, shape = region, group = term_effect
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", colour = "grey75") +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
    geom_point() +
    labs(
      x = "Spatial scale",
      y = bquote("Effect"~~"("*italic("S")*")")
    ) +
    scale_fill_manual(values = c(NA, "black", "white")) +
    scale_shape_manual(values = c(4, 21, 21)) +
    scale_alpha_manual(values = c(1, 0.25)) +
    facet_wrap(~term, nrow = 2) +
    theme(
      axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5),
      axis.text.y  = element_text(angle = 90, hjust = 0.5),
      strip.text.x = element_text(angle =  0, hjust = 0)
    )
```

```{r, eval=FALSE}
data_all_scales <- data %$% rbind(
  QDS %>%
    rename(richness = QDS_richness) %>%
    add_column(scale = "QDS") %>%
    dplyr::select(scale, region, Elevation:pH, richness),
  HDS %>%
    rename(richness = HDS_richness) %>%
    add_column(scale = "HDS") %>%
    dplyr::select(scale, region, Elevation:pH, richness),
  DS %>%
    rename(richness = DS_richness) %>%
    add_column(scale = "DS") %>%
    dplyr::select(scale, region, Elevation:pH, richness)
)
full_formula <- predictor_names[predictor_names != "PC1"] %>%
  {c(., paste(., "* region * scale"))} %>%
  paste(collapse = " + ")

m_all_scales <- lm(glue("richness ~ {full_formula}"), data_all_scales)
m_all_scales %<>% step()
preds_w_interactions <- m_all_scales %$%
  coefficients %>%
  names() %>%
  magrittr::extract(str_which(., ":(regionSWAFR|scale.?DS)"))
reparameterisation <- preds_w_interactions %>%
  str_remove(":(regionSWAFR|scale.?DS)") %>%
  unique() %>%
  {glue("-{.}")} %>%
  paste(collapse = " ")
m_all_scales %<>% update(
  formula = glue(". ~ . {reparameterisation}"),
  data    = data_all_scales
)
summary(m_all_scales)
m_all_scales %>%
  tidy(conf.int = TRUE) %>%
  dplyr::select(-std.error, -statistic) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    region = 
      case_when(
        str_detect(term, "regionSWAFR") ~ "SWAFR", 
        str_detect(term, "regionGCFR")  ~ "GCFR",
        TRUE                            ~ "Main effect only"
      ) %>%
      factor(levels = c("Main effect only", "GCFR", "SWAFR")),
    scale =
      case_when(
        str_detect(term, "scaleQDS") ~ "QDS", 
        str_detect(term, "scaleHDS") ~ "HDS",
        str_detect(term, "scaleDS")  ~ "DS"
      ) %>%
      factor(levels = c("Main effect only", "QDS", "HDS", "DS")),
    term = term %>%
      str_replace_all("_", " ") %>%
      str_remove_all("(scale|region)(.?DS|(SWA|GC)FR):"),
    sig = ifelse(p.value < 0.05, "< 0.05", "NS")
  ) %>%
  filter(term %in% var_names) %>%
  mutate(term = factor(term, levels = c(var_names, "regionSWAFR", "scaleQDS", "scaleHDS"))) %>%
  ggplot() +
    aes(
      term, estimate,
      colour = scale, fill = region, shape = region,
      alpha = sig
    ) +
    geom_hline(yintercept = 0, linetype = "dashed", colour = "grey75") +
    geom_errorbar(
      aes(ymin = conf.low, ymax = conf.high),
      position = position_dodge(width = 0.25),
      width = 0
    ) +
    geom_point(position = position_dodge(width = 0.25), size = 2) +
    labs(
      x = "Heterogeneity predictor",
      y = bquote(
        "Effect"~~
        "(log"["10"]*italic("S")*")"
      )
    ) +
    scale_fill_manual(values = c(NA, "black", "white")) +
    scale_shape_manual(values = c(4, 21, 21)) +
    scale_alpha_manual(values = c(1, 0.25)) +
    guides(
      fill = FALSE,
      shape = guide_legend(
        title = "Effect type",
        override.aes = list(fill = c(NA, "black", "white"))
      ),
      alpha = guide_legend(
        title = bquote(italic("P")["Effect"]),
        override.aes = list(alpha = c(1, 0.25), linetype = NA)
      )
    ) +
    theme(
      axis.text.x  = element_text(angle = 90, hjust = 1, vjust = 0.5),
      axis.text.y  = element_text(angle = 90, hjust = 0.5),
      strip.text.x = element_text(angle =  0, hjust = 0)
    )
```
