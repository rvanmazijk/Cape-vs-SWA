## 3.1. Separate environmental variable models

Tables 4 and 5 present the results of simple linear regressions of each form of environmental heterogeneity separately as predictors of vascular plant species richness at the HDS-scale ($S_{\mathrm{HDS}}$) and QDS-scale ($S_{\mathrm{QDS}}$). In each table, the "best" model (sensu $AIC$) was select as the simplest model with $\Delta AIC < 2$---i.e. a more complex model was only justified when it had the lowest $AIC$-score by more than 2 $AIC$-units.

For $S_{\mathrm{HDS}}$ (Table 4), there is evidence for a great difference in the slopes of the GCFR and SWAFR's relationships with heterogeneity in MAP. Heterogneity in NDVI and clay only present evidence for the same slope in each region, but differing intercepts. Heterogeneity in CEC and pH have non-significant slopes and signficiant region-effects---suggesting that these variables values' have weak relationships with $S_{\mathrm{HDS}}$, and that the region-effect explains more of the variance. Other variables (heterogeneity in elevation, PDQ, surface T and soil C) only present evidence for a continuous effect of that heterogeneity, explaining the difference in the regions' $S_{\mathrm{HDS}}$ in terms of the roughness values themselves, without the need to invoke a region term. Think of it this way:

- If there is no need for any information concerning the region a cell belongs to, then the environmental roughness "rule" is followed well across the two regions in a similar way.
- If the region-effect is significant, but not the roughness effect, then that roughness axis isn't doing a very good job of explaining anything, and must defer to the region-effect.
- When both the region- and roughness-effect are significant, this represents a softer version of the above, where the roughness axis can explain some variance, but not all.
- When there is a significant interaction between region and roughness, then each region is playing a whole new game with that axes in terms of how richness is being driven.

<!--
At the QDS-scale, concerning $S_{\mathrm{QDS}}$ (Table 6), it is noteworthy that all axes best-supported to have an additive region term only also had non-significant roughness-effects [expand?].
-->

I also regressed against PC1. Like heterogeneity in elevation and surface T, PC1 was the only explanatory variable "needed" in regressions for $S_{\mathrm{HDS}}$ (also see Figure 4) and $S_{\mathrm{QDS}}$. Figure 4 shows quite nicely how, in general, the GCFR and SWAFR are following the same "rule" (species richness increases with increasing environmental heterogeneity (PC1)) but occupy different areas along that relationship (the GCFR being more rich and more rough than the SWAFR).

```{r helper-functions}
fit_combined_region_models <- function(response) {
  stopifnot(exprs = {
    response %in% c("HDS_richness", "QDS_richness", "add_turnover_prop")
    # Datasets must be loaded before running this function
    exists("HDS")
    exists("QDS")
  })
  
  dataset <- if (response == "QDS_richness") QDS else HDS
  
  # Select roughness & PC1 predictor names
  predictor_names <- names(dataset)[
    str_which(names(dataset), "(roughness|PC1)")
  ]
  
  # Fit no-region, additive & interaction models & summarise w/ broom::
  models_no_region <- predictor_names %>%
    map(~lm(glue("{response} ~ {.x}"), dataset)) %>%
    set_names(predictor_names) %>%
    {tibble(predictor = names(.), model = .)} %>%
    mutate(
      slope         = map_dbl(model, ~tidy(.x)$estimate[2]),
      slope_p_value = map_dbl(model, ~tidy(.x)$p.value[ 2]),
      r_squared     = map_dbl(model, ~glance(.x)$r.squared),
      slope_sig     = ifelse(slope_p_value <= 0.05, "*", "")
    )
  models_add_region <- predictor_names %>%
    map(~lm(glue("{response} ~ {.x} + region"), dataset)) %>%
    set_names(predictor_names) %>%
    {tibble(predictor = names(.), model = .)} %>%
    mutate(
      slope          = map_dbl(model, ~tidy(.x)$estimate[2]),
      slope_p_value  = map_dbl(model, ~tidy(.x)$p.value[ 2]),
      region_coeff   = map_dbl(model, ~tidy(.x)$estimate[3]),
      region_p_value = map_dbl(model, ~tidy(.x)$p.value[ 3]),
      r_squared      = map_dbl(model, ~glance(.x)$r.squared),
      slope_sig      = ifelse(slope_p_value  <= 0.05, "*", ""),
      region_sig     = ifelse(region_p_value <= 0.05, "*", "")
    )
  models_int_region <- predictor_names %>%
    map(~lm(glue("{response} ~ {.x} * region"), dataset)) %>%
    set_names(predictor_names) %>%
    {tibble(predictor = names(.), model = .)} %>%
    mutate(
      slope          = map_dbl(model, ~tidy(.x)$estimate[2]),
      slope_p_value  = map_dbl(model, ~tidy(.x)$p.value[ 2]),
      region_coeff   = map_dbl(model, ~tidy(.x)$estimate[3]),
      region_p_value = map_dbl(model, ~tidy(.x)$p.value[ 3]),
      int_coeff      = map_dbl(model, ~tidy(.x)$estimate[4]),
      int_p_value    = map_dbl(model, ~tidy(.x)$p.value[ 4]),
      r_squared      = map_dbl(model, ~glance(.x)$r.squared),
      slope_sig      = ifelse(slope_p_value  <= 0.05, "*", ""),
      region_sig     = ifelse(region_p_value <= 0.05, "*", ""),
      int_sig        = ifelse(int_p_value    <= 0.05, "*", "")
    )
  
  # Neaten up & return
  models_no_region[c(
    "region_coeff", "region_p_value", "region_sig",
    "int_coeff",    "int_p_value",    "int_sig"
  )] <- NA
  models_add_region[c(
    "int_coeff",    "int_p_value",    "int_sig"
  )] <- NA
  models <- as_tibble(rbind(
    cbind(region_term = "none", models_no_region),
    cbind(region_term = "add",  models_add_region),
    cbind(region_term = "int",  models_int_region)
  ))
  models$response <- response
  models
}

check_region_effects_all_same <- function(models) {
  check <- models %>%
    mutate(region_term_name = model %>%
      map(~tidy(.x)$term) %>%
      map_chr(paste, collapse = ", ")
    ) %>%
    pull(region_term_name) %>%
    str_detect("GCFR") %>%
    any()
  if (check) print("Uh-oh! Some region-terms are for GCFR")
}

compare_combined_region_models <- function(models, response = NULL) {
  if (is.null(response)) {
    response <- unique(models$response)
  }
  
  # Get AICs etc.
  models_summary <- models %>%
    group_by(predictor) %>%
    mutate(aic = map_dbl(model, AIC)) %>%
    mutate(
      model_rank = as.numeric(region_term),
      delta_aic  = aic - min(aic),
      # Choose the "best" ^ "simplest" model
      best_model = (model_rank == min(model_rank[delta_aic < 2]))
    ) %>%
    ungroup()
  
  models_summary_printable <- models_summary %>%
    filter(best_model) %>%
    mutate(
      model_type = 
        case_when(
          region_term == "none"                        ~ "Main effect only",
          region_term == "add" & slope_p_value <  0.05 ~ "Main effect + region",
          region_term == "add" & slope_p_value >= 0.05 ~ "Region only",
          region_term == "int"                 ~ "Main effect $\\times$ region"
        ) %>%
        factor(levels = c(
          "Main effect $\\times$ region",
          "Main effect + region",
          "Main effect only",
          "Region only"
        )),
      predictor = predictor %>%
        str_remove_all("_roughness") %>%
        str_replace_all("\\.", " "),
      slope_sign  = ifelse(slope        > 0, "+", "-"),
      region_sign = ifelse(region_coeff > 0, "+", "-"),
      int_sign    = ifelse(int_coeff    > 0, "+", "-")
    ) %>%
    mutate_at(c("slope_p_value", "region_p_value", "int_p_value"),
      ~ case_when(
        .x < 0.001 ~ "***",
        .x < 0.010 ~ "**",
        .x < 0.050 ~ "*",
        .x < 0.100 ~ ".",
        TRUE       ~ " "
      )
    ) %>%
    mutate_if(is.character, ~ ifelse(is.na(.x), " ", .x)) %>%
    dplyr::select(
      model_type,  predictor,
      slope_sign,  slope_p_value,
      region_sign, region_p_value,
      int_sign,    int_p_value
    ) %>%
    arrange(model_type)
  
  # Remove variable names after first mention in table
  models_summary_printable$model_type %<>% as.character()
  for (pred in unique(models_summary_printable$model_type)) {
    to_remove <- which(models_summary_printable$model_type == pred)[-1]
    models_summary_printable$model_type[to_remove] <- " "
  }

  # Print summary table
  response <- case_when(
    response == "HDS_richness"      ~ "$S_{\\mathrm{HDS}}$",
    response == "QDS_richness"      ~ "$S_{\\mathrm{QDS}}$",
    response == "add_turnover_prop" ~ "$T_{\\mathrm{QDS}} / S_{\\mathrm{HDS}}$"
  )
  knitr::kable(models_summary_printable,
    caption = glue(
      "Summarised results of the best fitting separate simple linear \\
      regressions of {response} against environmental heterogeneity variables."
    ),
    col.names = c(
      "Model type", "Heterogeneity predictor",
      "Slope",        " ",
      "SWAFR effect", " ",
      "Slope:SWAFR",  " "
    ),
    align = "llclclcl"
  )
}
```

```{r combined-region-HDS-richness-models}
combined_region_HDS_models <- fit_combined_region_models("HDS_richness")
check_region_effects_all_same(combined_region_HDS_models)
compare_combined_region_models(combined_region_HDS_models)
```

```{r combined-region-QDS-richness-models}
combined_region_QDS_models <- fit_combined_region_models("QDS_richness")
check_region_effects_all_same(combined_region_QDS_models)
compare_combined_region_models(combined_region_QDS_models)
```

```{r import-cellular-PCA-results, include=FALSE}
QDS_PCA <- read_rds(here("draft-02/outputs/EDS_roughness_cells_PCA.RDS"))
HDS_PCA <- read_rds(here("draft-02/outputs/QDS_roughness_cells_PCA.RDS"))
summary(QDS_PCA)$importance[2, 1]
summary(HDS_PCA)$importance[2, 1]
```

```{r look-at-combined-region-PC1-model-r-squareds, include=FALSE}
combined_region_HDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  glance() %>%
  pull(r.squared)
combined_region_QDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  glance() %>%
  pull(r.squared)
```

```{r plot-combined-region-PC1-models, fig.width=6, fig.height=3, fig.cap="Fits of simple linear regressions of (a) $S_{\\mathrm{HDS}}$ ($R^2 = 0.23$) and (b) $S_{\\mathrm{QDS}}$ ($R^2 = 0.15$) against each respective scale's PC1 scores for the combined-region dataset. These models are described in the last rows of Tables 4 and 5 respectively. Grey bands denote 95% confidence intervals. PC1 at the QDS-scale explained 39.86% of the variation in environmental heterogeneity. PC1 at the HDS-scale explained 41.55% of the variation in environmental heterogeneity."}
translucent_white <- rgb(1, 1, 1, 0.5)
HDS_QDS %>%
  filter(metric %in% c("HDS_richness", "QDS_richness")) %>%
  mutate(metric = case_when(
    metric == "HDS_richness" ~ "(a) HDS-scale",
    metric == "QDS_richness" ~ "(b) QDS-scale"
  )) %>%
  rename(scale = metric) %>%
  ggplot(aes(PC1, value)) +
    geom_point(aes(fill = region), shape = 21, colour = "black") +
    geom_smooth(method = lm, colour = "black") +
    ylab(bquote(italic("S"))) +
    scale_fill_manual(name = "Region", values = c("black", translucent_white)) +
    facet_grid(~scale) +
    theme(
      legend.background = element_rect(fill = NA),
      axis.text.y       = element_text(angle = 90, hjust = 0.5),
      strip.text        = element_text(hjust = 0)
    )
```

```{r map-combined-region-PC1-model-residuals, fig.width=6, fig.height=5, fig.cap="Residuals from the models in Figure 4, mapped geographically."}
HDS$PC1_model_residual <- combined_region_HDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  residuals()
HDS$PC1_model_fit <- combined_region_HDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  fitted.values()

QDS$PC1_model_residual <- combined_region_QDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  residuals()
QDS$PC1_model_fit <- combined_region_QDS_models %>%
  filter(predictor == "PC1" & region_term == "none") %>%
  pull(model) %>%
  extract2(1) %>%
  fitted.values()

lon_scale <- scale_x_continuous(breaks = c(
  18, 20, 22, 24, 26,
  114, 116, 118, 120, 122, 124, 126
))

HDS_map <- ggplot(HDS, aes(lon, lat, fill = PC1_model_residual)) +
  geom_tile() +
  facet_grid(~region, scales = "free") +
  labs(x = "Longitude (º)", y = "Latitude (º)") +
  scale_fill_viridis_c(name = bquote("Residual"~italic("S")["HDS"])) +
  theme(
    axis.title.x = element_blank(),
    axis.text.y  = element_text(angle = 90, hjust = 0.5)
  ) +
  lon_scale

QDS_map <- ggplot(QDS, aes(lon, lat, fill = PC1_model_residual)) +
  geom_tile() +
  facet_grid(~region, scales = "free") +
  labs(x = "Longitude (º)", y = "Latitude (º)") +
  scale_fill_viridis_c(name = bquote("Residual"~italic("S")["QDS"])) +
  theme(
    axis.text.y = element_text(angle = 90, hjust = 0.5),
    strip.text  = element_blank()
  ) +
  lon_scale

plot_grid(HDS_map, QDS_map, nrow = 2)
```

```{r, eval=FALSE}
ggplot(HDS, aes(HDS_richness, PC1_model_fit, colour = region)) +
  geom_abline(
    slope = 1, intercept = 0,
    linetype = "dashed", colour = "grey75"
  ) +
  geom_point() +
  lims(x = c(0, 3100), y = c(0, 3100))
```
