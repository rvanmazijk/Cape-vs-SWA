## 3.3. Combined-regions models with combinations of variables

See Figure 6 and Table 8.

```{r fit-combined-region-multivariate-models}
fit_combined_region_multivariate <- function(response) {
  stopifnot(exists("var_names"))

  dataset <- if (response == "QDS_richness") QDS else HDS

  roughness_var_names <- var_names %>%
    str_replace_all(" ", ".") %>%
    paste0("_roughness") %>%
    {c(., paste(., "* region"))}
  roughness_formula <- paste(roughness_var_names, collapse = " + ")
  roughness_formula <- glue("{response} ~ {roughness_formula}")
  
  m <- lm(roughness_formula, dataset)
  step(m, direction = "backward", trace = 0)
}

m_HDS_richness      <- fit_combined_region_multivariate("HDS_richness")
m_QDS_richness      <- fit_combined_region_multivariate("QDS_richness")
m_add_turnover_prop <- fit_combined_region_multivariate("add_turnover_prop")

m_HDS_richness$data      <- HDS
m_QDS_richness$data      <- QDS
m_add_turnover_prop$data <- HDS

models <- list(m_HDS_richness, m_QDS_richness, m_add_turnover_prop)
names(models) <- c("HDS_richness", "QDS_richness", "QDS_turnover")
```

\clearpage

### Manual model simplification

Try removing interaction terms from the $S_{\mathrm{HDS}}$-model:

```{r simplify-HDS-richness-model}
step_model <- models$HDS_richness
sans_elev <- update(
  models$HDS_richness,
  formula = ". ~ . -Elevation_roughness:region",
  data    = HDS
)
sans_CEC <- update(
  models$HDS_richness,
  formula = ". ~ . -CEC_roughness:region",
  data    = HDS
)
sans_soilC <- update(
  models$HDS_richness,
  formula = ". ~ . -Soil.C_roughness:region",
  data    = HDS
)
sans_all <- update(
  models$HDS_richness,
  formula = paste(". ~ .",
    "-Elevation_roughness:region",
    "-CEC_roughness:region",
    "-Soil.C_roughness:region"
  ),
  data = HDS
)
AIC(step_model, sans_elev, sans_CEC, sans_soilC, sans_all) %>%
  transmute(
    Delta_AIC     = AIC - min(AIC),
    relative_L    = exp(-0.5 * Delta_AIC),
    Akaike_weight = relative_L / sum(relative_L)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  set_rownames(c(
    "`step(model)`",
    "Sans Elevation:Region",
    "Sans CEC:Region",
    "Sans Soil C:Region",
    "Sans all 3"
  )) %>%
  knitr::kable(
    row.names = TRUE,
    col.names = c("$\\Delta AIC$", "Relative $L$", "$w_{\\mathrm{Akaike}}$")
  )
```

Try removing terms & their interactions with region from the $T_{\mathrm{QDS}}/S_{\mathrm{HDS}}$-model:

```{r simplify-QDS-turnover-model}
step_model <- models$QDS_turnover
sans_PDQ <- update(
  models$QDS_turnover,
  formula = ". ~ . -PDQ_roughness:region",
  data    = HDS
)
sans_surfT <- update(
  models$QDS_turnover,
  formula = ". ~ . -Surface.T_roughness:region",
  data    = HDS
)
sans_CEC <- update(
  models$QDS_turnover,
  formula = ". ~ . -CEC_roughness:region",
  data    = HDS
)
sans_soilC <- update(
  models$QDS_turnover,
  formula = ". ~ . -Soil.C_roughness:region",
  data    = HDS
)
sans_all <- update(
  models$QDS_turnover,
  formula = paste(". ~ .",
    "-PDQ_roughness:region",
    "-Surface.T_roughness:region",
    "-CEC_roughness:region",
    "-Soil.C_roughness:region"
  ),
  data = HDS
)

AIC(step_model, sans_PDQ, sans_surfT, sans_CEC, sans_soilC, sans_all) %>%
  transmute(
    Delta_AIC     = AIC - min(AIC),
    relative_L    = exp(-0.5 * Delta_AIC),
    Akaike_weight = relative_L / sum(relative_L)
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  set_rownames(c(
    "`step(model)`",
    "Sans PDQ:Region",
    "Sans Surface T:Region",
    "Sans CEC:Region",
    "Sans Soil C:Region",
    "Sans all 4"
  )) %>%
  knitr::kable(
    row.names = TRUE,
    col.names = c("$\\Delta AIC$", "Relative $L$", "$w_{\\mathrm{Akaike}}$")
  )
```

```{r reparamaterise-models}
# Reparameterise models to {*}:regionGCFR & {*}:regionSWAFR
# a.o.t. {*}*region, so that the figure of the effects actually represents
# each region, not the baseline (GCFR) and "relative SWAFR"
# (and that would cause inconsistencies too when their is no interaction with
# region term for a roughness variable).
reparameterise <- function(m) {
  response <- colnames(m$model)[[1]]
  data <- if (response == "QDS_richness") QDS else HDS
  preds_w_interactions <- m %$%
    coefficients %>%
    names() %>%
    magrittr::extract(str_which(., ":regionSWAFR"))
  reparameterisation <- preds_w_interactions %<>%
    str_remove(":regionSWAFR") %>%
    {glue("-{.}")} %>%
    paste(collapse = " ")
  update(m,
    formula = glue(". ~ . {reparameterisation}"),
    data    = data
  )
}
# Test
#a <- models$HDS_richness
#b <- reparameterise(models$HDS_richness)
#AIC(a, b) # same model! :)
models %<>% map(reparameterise)
```

\clearpage

```{r summarise-combined-region-multivariate-models}
models_summary <- models %>%
  map_df(.id = "response", tidy, conf.int = TRUE) %>%
  dplyr::select(-std.error, -statistic) %>%
  filter(term != "(Intercept)") %>%
  mutate(term = str_remove_all(term, "_roughness"))

models_R2 <- models %>%
  map_df(.id = "response", glance) %>%
  dplyr::select(response, adj.r.squared)

models_summary %<>% full_join(models_R2)

models_summary_printable <- models_summary %>%
  dplyr::select(response, term, estimate, p.value, adj.r.squared) %>%
  mutate_at(c("estimate", "adj.r.squared"),
    ~format(round(.x, 2), nsmall = 2)
  ) %>%
  mutate(sig = case_when(
    p.value < 0.001 ~ "***",
    p.value < 0.010 ~ "**",
    p.value < 0.050 ~ "*",
    p.value < 0.100 ~ ".",
    TRUE            ~ " "
  )) %>%
  dplyr::select(response, adj.r.squared, term, estimate, sig)
replace_if_repeat <- function(x, r = " ") {
  for (i in 2:length(x)) {
    if (x[[i]] %in% x[1:(i - 1)]) {
      x[[i]] <- r
    }
  }
  x
}
models_summary_printable$response      %<>% replace_if_repeat()
models_summary_printable$adj.r.squared %<>% replace_if_repeat()
knitr::kable(models_summary_printable,
  caption = paste(
    "See Figure 6.",
    "Significance is denoted with asterisks as follows:",
    "\"\\*\\*\\*\", $P < 0.001$;",
    "\"\\*\\*\", $0.001 < P < 0.01$;",
    "\"\\*\", $0.01 < P < 0.05$;",
    "\".\", $0.05 < P < 0.1$;
    and non-significant results ($P \\geq 0.1$) being left blank."
  ),
  col.names = c(
    "Response", "${R^2}_{adj}$",
    "Heterogeneity predictor", "Slope", " "
  ),
  align = "lllrl"
)
```

```{r plot-combined-region-multivariate-models, fig.width=7, fig.height=6, fig.cap="Slope estimates of the three multiple linear regressions of (a) $S_{\\mathrm{HDS}}$, (b) $S_{\\mathrm{QDS}}$ and (c) $T_{\\mathrm{QDS}} / S_{\\mathrm{HDS}}$ againt environmental heterogeneity variables interacting with region. Each model was simplified using reverse stepwise regression model selection using $AIC$-scores. Points with error bars denote slope estimates and their 95% confidence intervals. All estimates were significant ($P < 0.05$) unless otherwise stated ($0.10 > P > 0.05$, almost significant, \"AS\"; $P > 0.05$, not significant, \"NS\")."}
models_summary_for_plot <- models_summary %>%
  mutate(
    response = case_when(
      response == "HDS_richness" ~ "(a)~~italic(S)[HDS]",
      response == "QDS_richness" ~ "(b)~~italic(S)[QDS]",
      response == "QDS_turnover" ~ "(c)~~italic(T)[QDS]/italic(S)[HDS]"
    ),
    region = 
      case_when(
        str_detect(term, "regionSWAFR") ~ "SWAFR", 
        str_detect(term, "regionGCFR")  ~ "GCFR",
        TRUE                             ~ "Main effect only"
      ) %>%
      factor(levels = c("Main effect only", "GCFR", "SWAFR")),
    term = term %>%
      str_replace_all("\\.", " ") %>%
      str_remove_all("regionSWAFR:") %>%
      str_remove_all("regionGCFR:") %>%
      factor(levels = c(var_names, "regionSWAFR")),
    sig = case_when(
      p.value < 0.05 ~ " ",
      p.value < 0.10 ~ "AS",
      TRUE           ~ "NS"
    )
  )
ggplot(models_summary_for_plot) +
  aes(term, estimate, fill = region, group = region) +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey75") +
  geom_errorbar(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.25),
    width = 0
  ) +
  geom_point(
    shape = 21,
    position = position_dodge(width = 0.25)
  ) +
  geom_text(aes(label = sig), nudge_x = 0.375, size = 3) +
  labs(x = "Heterogeneity predictor", y = "Slope") +
  scale_fill_manual(
    name   = "Effect type",
    values = c("grey50", "black", "white")
  ) +
  facet_wrap(~response, nrow = 3, scales = "free_y", labeller = label_parsed) +
  theme(
    axis.text.x  = element_text(angle = 90, hjust = 1),
    strip.text.x = element_text(angle =  0, hjust = 0)
  )
```
