```{r setup, include=FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

\break

# Biosketches {-}

**Ruan van Mazijk** is a Masters student broadly interested in comparative biology and ...<!--TODO: finish-->

**Michael D. Cramer** <!--TODO-->

**G. Anthony Verboom** <!--TODO-->

# Author contributions {-}

MDC and GAV conceived the study question, which RVM investigated under their supervision for his BSc Hons project. The analyses and programming work were largely devised by RVM, with input from the other authors, and was carried out by RVM. RVM wrote the first draft of the manuscript and all authors contributed equally thereafter.

# ORCID numbers {-}

RVM: 0000-0003-2659-6909

MDC: 0000-0003-0989-3266

GAV: 0000-0002-1363-9781<!--?-->

\break

# Tables {-}

```{r setup-tables, include=FALSE}
source(here::here("setup.R"))
data_sources <- read_csv(here::here("manuscript/data-sources.csv"))
import_objects(
  here::here("outputs/species-turnover-and-richness/")
)
import_objects(
  here::here("outputs/species-turnover-w-distance/"),
  ignore_RDS = TRUE
)
import_objects(
  here::here("outputs/species-and-roughness/"),
  ignore_RDS = TRUE
)
```

```{r data-sources, results="asis"}
data_sources %>%
  knitr::kable(
    booktabs = TRUE,
    caption = "(ref:data-sources)"
  ) %>%
  kableExtra::kable_styling(latex_options = "hold_position")
# TODO: use kableExtra::group_rows() a.o.t. these cheat-rows!
```

(ref:data-sources) Data sources used in this study. Abbreviations are as follows:<!--TODO-->.

```{r turnover-vs-geodist-model-table, results="asis"}
tidy_terms <- c(
  "Intercept",
  "log Distance between cells",
  "Cape",
  "log Distance between cells $\\times$ Cape"
)
species_turnover_geodist_m_tidy %>%
  my_model_table(tidy_terms = tidy_terms) %>%
  magrittr::extract("model_table") %>%
  knitr::kable(
    escape = FALSE,
    booktabs = TRUE,
    caption = "(ref:turnover-vs-geodist-model-table)"
  ) %>%
  kableExtra::kable_styling(latex_options = "hold_position")
```

(ref:turnover-vs-geodist-model-table) Estimated coefficients and significances ($P$-value) following quantile regression of the 5%-quantile ($\tau = 0.05$) of pairwise species turnover (as Jaccards distance) as a function of the geographic distance (km, log-transformed) between QDS cells.
The Cape term represents the difference between Cape and SWA species turnover, for a given geographic distance.

```{r species-model-table, results="asis"}
tidy_terms <- c(
  "Intercept",
  "$log(\\overline{S_{QDS}} + 1)$",
  "$\\overline{J_{QDS}}$",
  "$SWA$",
  "$log(\\overline{S_{QDS}} + 1) \\times SWA$",
  "$\\overline{J_{QDS}} \\times SWA$"
)
out <- my_model_table(
  model = species_turnover_richness_HDS_m,
  tidy_terms = tidy_terms,
  AIC_table = species_HDS_AIC_table
)
out %>%
  magrittr::extract("model_table") %>%
  knitr::kable(
    escape = FALSE,
    booktabs = TRUE,
    align = c("l", "r", "r"),
    caption = "(ref:species-model-table)"
  ) %>%
  kableExtra::kable_styling(latex_options = "hold_position")
```

(ref:species-model-table) Estimated coefficients and significances ($P$-value) following multiple linear regression of HDS species richness ($S_{HDS}$) against the mean QDS species richness ($\overline{S_{QDS}}$) and turnover ($\overline{J_{QDS}}$; Jaccards distance) within a given HDS, of the form in Equation \@ref(eq:S-HDS-formula).
The Cape was fit as the baseline, hence SWA represents the categorical term here.
This was model was better fitting than a similar model without a region category ($\Delta AIC =$ `r out$deltaAIC`).
<!--TODO: use SWA as baseline? to be more consistent w/ tab:turnover-vs-geodist-model-table-->
Note, this model does not represent those curves plot in Figures \@ref(fig:richness-vs-turnover) and \@ref(fig:richness-vs-turnover-3QDS) (there, the curves are from simple linear regressions of the variables in each panel, separated by region).

<!--
NOTE: do I need this? Maybe as supplementary?

```{r species-model-table-3QDS, results="asis"}
out <- my_model_table(
  model = species_turnover_richness_3QDS_m,
  tidy_terms = tidy_terms,  # from previous chunk
  AIC_table = species_3QDS_AIC_table
)
out %>%
  magrittr::extract("model_table") %>%
  knitr::kable(
    escape = FALSE,
    booktabs = TRUE,
    align = c("l", "r", "r"),
    caption = "(ref:species-model-table-3QDS)"
  ) %>%
  kableExtra::kable_styling(latex_options = "hold_position")
```

(ref:species-model-table-3QDS) Estimated coefficients and significances ($P$-value) following multiple linear regression of 3QDS species richness ($S_{3QDS}$) against the mean QDS richness ($\overline{S_{QDS}}$) ($log(x + 1)$-transformed) and turnover ($\overline{J_{QDS}}$, as Jaccards distance) within a given HDS, of the form in Equation \@ref(eq:S-HDS-formula).
The Cape was fit as the baseline, hence the SWA represents the categorical term here.
These models were better fitting than similar models without region categories ($\Delta AIC =$ `r out$deltaAIC`).
Note, this model does not represent those curves plot in Figures \@ref(fig:richness-vs-turnover)B,C and \@ref(fig:richness-vs-turnover-3QDS) (there, the curves are from simple linear regressions of the variables in each panel, separated by region).

-->

```{r species-roughness-AICc, results="asis"}
out <- bind_rows(.id = "region", list(
  Cape = GCFR_models_AICc_all, 
  SWA = SWAFR_models_AICc_all,
  Both = combined_models_AICc_all
))
out %>%
  mutate(model = case_when(
    model == "null"     ~ "Null",
    model == "full"     ~ "All",
    model == "abs"      ~ "Absolute variables",
    model == "rough"    ~ "Roughness variables",
    model == "elev"     ~ "Elevation",
    model == "non_elev" ~ "Non-elevation variables",
    model == "soil"     ~ "Soil variables",
    model == "non_soil" ~ "Non-soil variables"
  )) %>%
  mutate_if(is.numeric, function(x) {
    x %>%
      round(digits = 2) %>%
      format(digits = 3, nsmall = 2)
  }) %>%
  arrange(region, delta_AICc) %>%
  select(-region) %>%
  knitr::kable(
    escape = FALSE,
    booktabs = TRUE,
    align = c("l", "r", "r", "r"),
    col.names = c("Model predictors", "$AICc$", "$\\Delta AICc$", "$w_{AICc}$"),
    caption = "(ref:species-roughness-AICc)"
  ) %>%
  kableExtra::group_rows("Cape:", 1, 8) %>%
  kableExtra::group_rows("SWA:", 9, 16) %>%
  kableExtra::group_rows("Both:", 17, 24) %>%
  kableExtra::kable_styling(latex_options = "hold_position")
```

(ref:species-roughness-AICc) Comparisons of Akaike information criterion values (small sample-size-corrected, $AICc$) of various geographically weighted regressions (GWR) of log-transformed species richness as a function of various sets of environmental variables. 
Models were fit for the Cape and SWA richness and environmental data both separately and together. 
GWR methods preclude the need for a categorical predictor for the Cape vs SWA, as the longitudinal (and to a lesser extent latitudinal) differences between the regions allows local regression coefficients in each region to differ. 
<!--TODO: complete/expand: Models fit for each of the three geographic extents: null ($S_{ij} \sim \beta_{0}_{ij} + \beta_{1}_{ij} Lon_{ij} + \beta_{2}_{ij} Lat_{ij} + \beta\epsilon_{ij}$), ...-->

\break

# Figure captions {-}

Captions are also repeated alongside their respective figures for readability.

## Figure \@ref(fig:roughness) {-}

<!--Old violin-plot-style Figure 1:-->

<!--
(ref:roughness) Comparisons of distributions of calculated environmental roughness values in the Cape and SWA, for elevation, NDVI and climatic variables (**A,B**) and edaphic variables (**C,D**).
Each row of panels within **A,C** and **B,D** illustrate the distributions for a different variable.
Violin-plots (**A,C**) of the distributions of roughness values (Z-scaled to be comparable across panels) are presented at 0.05ยบ and 3QDS scales.
Roughness values were calculated following Equation \@ref(eq:roughness).
Areas beneath curves sum to one for each violin, and points within represent the median of each distribution.
Violin-plots were constructed with Gaussian distributions with bandwidth following Silverman's "rule of thumb" [@Silverman1986].
The degree to which Cape roughness values exceed SWA values is described by the $CLES$ (see Materials and methods).
Roughness values were found to be significantly greater in the Cape in all cases ($P < 0.05$), unless marked as non-significant (NS), following Mann-Whitney $U$ tests.
The magnitude of the ranges of Z-scaled roughness values (**B,D**) vary with spatial resolution, described here by the 95%-to-5% and 99%-to-1% interquantile ranges.
Lines connect points for illustration, and are paler for the wider quantile.
-->
<!--TODO: change IQuR in y-axes simply to "Range"-->
<!--TODO: plot jittered points on 3QDS violins, as I have seen when fiddling with PCAs that there are indeed very few points for those distributions (which is fine, but note it!)-->

<!--New jackknife-style Figure 1:-->

(ref:roughness) Comparisons of different types of environmental heterogeneity in the Cape and SWA. 
(a) Example distributions of roughness values (Equation \@ref(eqn:roughness)), showing the different extremes in environmental heterogeneity observed in each region when compared at fine (0.05ยบ) and coarse (3QDS) scales. 
Each distribution has under it area 1. 
Distributions were constructed with Gaussian kernels, with bandwidth following Silverman's "rule of thumb" [@Silverman1986; $0.9 \times min \left ( \left \{ \sigma, \frac{IQR}{1.34 \times n^{-\frac{1}{5}}} \right \} \right )$].
These distributions of roughness values were compared between the Cape and SWA at each of the four spatial scales, not just 0.05ยบ and 3QDS, using non-parametric Mann-Whitney $U$-tests to test for differences. 
The "common language effect size" ($CLES$, see text) describes these differences (b). 
$U$-tests for almost all environmental variables yielded significant differences ($P < 0.05$) between Cape and SWA values ($NS$, non-significant differences).

(ref:roughness)

## Figure \@ref(fig:richness-vs-turnover) {-}

(ref:richness-vs-turnover) Regressions involving plant species richness and turnover.
Species turnover (as Jaccards distance) between QDS-pairs increases as pairs are more geographically separated (a).
Species turnover was calculated for all possible pairs of cells, but only the turnover values for a random 5000 pairs in each region have been plotted, for clarity.
Fitted lines represent the 5%-quantile regressions of turnover as a function of log-distance for each region separately.
Following a 5%-quantile regression of turnover as a function of log-distance with region as a categorical variable (Table \@ref(tab:turnover-vs-geodist-model-table)), a significant interaction between distance and region was found ($P < 0.001$), such that the Cape positively effects the distance slope term.
Scatter-plots of HDS-scale species richness against the average QDS-scale richness in a given HDS (b) and the average species turnover between QDS in a given HDS (c).
Curves represent simples linear regressions of HDS richness against these two respective independent variables (note, mean QDS richness was $log(x + 1)$-transformed), separately for each region, for illustration of the two regions' differences.

(ref:richness-vs-turnover)

<!--
```{r richness-vs-turnover-3QDS, fig.cap="(ref:richness-vs-turnover-3QDS)"}
knitr::include_graphics(here::here("figures/richness-vs-turnover-3QDS.png"))
```

(ref:richness-vs-turnover-3QDS) [Same as \@ref(fig:richness-vs-turnover)B,C, but for 3QDS, not HDS, as the focal scale.]

(ref:richness-vs-turnover-3QDS)
-->

# Figures {-}

```{r setup-figures, include=FALSE}
source(here::here("setup.R"))
source_if_needed(
  output_path = here::here("figures/"),
  source_path = here::here("figures/make-figures.R"),
  import = FALSE
)
```

<!--
Use echo=FALSE explicitly in chunks below.
Avoids missing "Shaded" environment in LaTeX fragment.
-->

```{r roughness, echo=FALSE, fig.cap="(ref:roughness)", fig.pos="H", out.width="18cm"}
knitr::include_graphics(here::here("figures/fig-1-roughness_manual-edit.png"))
```

```{r richness-vs-turnover, echo=FALSE, fig.cap="(ref:richness-vs-turnover)", fig.pos="H", out.width="18cm"}
knitr::include_graphics(here::here("figures/fig-2-richness-vs-turnover.png"))
```
