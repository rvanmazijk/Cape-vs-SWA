---
title: "Testing for concordance between ranked lists"
subtitle: |
  | Supplementary Information
  | Cape vs SWA publication
author: "Ruan van Mazijk"
date: "`r Sys.Date()`"
mainfont: Times New Roman  # for PDF
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 4, fig.height = 4)
library(here)
source(here("R/setup.R"))
set.seed(1234)  # for reproducibility
data <- data.frame(category = letters[1:10], rank1 = 1:10)
data$rank1 <- sample(data$rank1)
data$rank2 <- sample(data$rank1)
comparison12 <- data %>%
  gather(rank_set, rank, -category) %>%
  mutate(rank_set = as.numeric(as.factor(rank_set))) %>%
  filter(rank_set %in% c(1, 2))
```

Suppose we have a dataset with two different rankings of the set of categories a--j, e.g.:

```{r print-data}
comparison12 %>%
  spread(category, rank) %>%
  select(a:j) %>%
  set_rownames(c("Ranking no. 1", "Ranking no. 2")) %>%
  knitr::kable(row.names = TRUE)
```

See Figure 1 for a graphical representation of these data.

# Quantifying rank change

How do we quantify the change in these categories' ranks moving from list no. 1 to 2? Generally, we wish to describe how many positions a category has changed in rank when moving from one list to the other. This can be represented mathematically rather intuitively. Formally, let $\delta_i$ be difference between the $i$^th^ category's position in one list ($p_1$) versus the other ($p_2$). Here, we do not wish to distinguish between positive and negative changes in position, so we shall take the absolute value of all $\delta_i$. Thus, the average change in rank between lists no. 1 and 2 ($\Delta_{1-2}$) is as follows:

\begin{align*}
  \Delta_{1-2} = \overline{| \delta |}
    &= \frac{1}{n} \sum_{i=1}^n | \delta_i | \\
    &= \frac{1}{n} \sum_{i=1}^n | {p_1}_i - {p_2}_i |
\end{align*}

```{r compute-Delta}
obs <- data %>%
  select(category, rank1, rank2) %>%
  mutate(rank_diff = abs(rank1 - rank2)) %>%
  summarise(mean_rank_diff = mean(rank_diff)) %>%
  pull("mean_rank_diff")
```

In the example data above, $\Delta_{1-2} = `r obs`$.

\clearpage

# Drawing inference about rank change

How do we know if some value of $\Delta_{1-2}$ differs from what chance would produce? Let us compute a randomised null average change in rank between the two lists by randomly re-ranking the categories in both lists 999 times, and rank our observed $\Delta_{1-2}$ amongst these 999 permutations (Figure 2).

```{r generate-null}
null <- replicate(999, {
  data %>%
    select(category, rank1, rank2) %>%
    mutate(rank1 = sample(rank1), rank2 = sample(rank2)) %>%
    mutate(rank_diff = abs(rank1 - rank2)) %>%
    summarise(mean_rank_diff = mean(rank_diff)) %>%
    pull("mean_rank_diff")
})
```

We can derived from this a $P$-value, using R, as follows:

```{r derive-p-value, echo=TRUE}
ranked_Deltas <- rank(c(obs, null))
obs_Delta_rank <- ranked_Deltas[1]
(p_value <- obs_Delta_rank / (999 + 1))
```

```{r visualise-data, fig.cap='Visualising rank change. Here, each point is an observation, and points have been organised by rank and coloured by their category. Points are connected with lines if they belong to the same category.'}
ggplot(comparison12, aes(factor(rank_set), factor(rank), col = category)) +
  geom_point(size = 3) +
  geom_line(aes(group = category), size = 1) +
  labs(x = "List", y = "Rank") +
  coord_flip() +
  theme(legend.position = "none")
```

```{r visualise-null-obs, fig.cap='Distribution of $\\Delta_{1-2}$-values from 999 permutations of rankings within the two lists, with our observed $\\Delta_{1-2}$ represented by the vertical dashed line.'}
hist(null, main = "", xlab = bquote("Delta"["1-2"]))
abline(v = obs, lty = "dashed")
```
