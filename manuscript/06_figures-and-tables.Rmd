# Figures & tables {-}

<!--TODO: update paths, move captions to bookdown "text references"-->

```{r setup-analyses}
source(here::here("setup.R"))
if (all(!folder_is_empty(here::here("analyses/04_outputs"),
                         here::here("analyses/05_outputs"),
                         here::here("analyses/06_outputs"),
                         here::here("analyses/07_outputs")))) {
    # Import the analyses' results
    for (output in c("04_outputs",
                     "05_outputs",
                     "06_outputs",
                     "07_outputs")) {
        import_all_objects_auto(here::here(glue("analyses/{output}")))
    }
} else {
    # Otherwise run the analyses needed first ...
    source(here::here("analyses/01_import-region-polygons.R"))
    source(here::here("analyses/02_import-floral-data.R"))
    source(here::here("analyses/03_import-environmental-data.R"))
    if (folder_is_empty(here::here("analyses/04_outputs"))) {
        source(here::here("analyses/04_analyse-roughness-across-scales.R"))
    }
    if (folder_is_empty(here::here("analyses/05_outputs"))) {
        source(here::here("analyses/05_analyse-species-turnover-w-distance.R"))
    }
    if (folder_is_empty(here::here("analyses/06_outputs"))) {
        source(here::here("analyses/06_analyse-species-turnover-and-richness.R"))
    }
    if (folder_is_empty(here::here("analyses/07_outputs"))) {
        source(here::here("analyses/07_analyse-species-and-roughness.R"))
    }
    # ... Then import the analyses' results
    for (output in c("04_outputs",
                     "05_outputs",
                     "06_outputs",
                     "07_outputs")) {
        import_all_objects_auto(here::here(glue("analyses/{output}")))
    }
}
var_names <- c(
    "Elevation",
    "MAP",
    "PDQ",
    "Surface T",
    "NDVI",
    "CEC",
    "Clay",
    "Soil C",
    "pH"
)
```

## Tables {-}

Variable | Source (Dataset code) | Citation
---------|-----------------------|---------
Elevation | SRTM (\<code\>) | @Farr2007
**Climate & vegetation variables** | | 
NDVI | MODIS (\<product code\>) | \<ref\>
Surface T | MODIS (\<product code\>) | \<ref\>
MAP | CHIRPS (\<product code\>) | \<ref\>
PDQ | CHIRPS (\<product code\>) | \<ref\>
**Soil variables (all from SoilGrids250m)** | |
pH | \<code\> | @Hengl2017
CEC | \<code\> |
Soil C | \<code\> |
Clay | \<code\> |
Plant species occurrence | GBIF | \<ref\>

Table: Data sources used in this study. Abbreviations are as follows: ... **TODO**

```{r full-model-table, results="asis"}

turnover_richness_HDS_m_tidy <- broom::tidy(turnover_richness_HDS_m)
betterness_AIC <- HDS_AIC_table %$%
    AIC %>%
    subtract(min(HDS_AIC_table$AIC)) %>%
    `[[`(2) %>%
    round(digits = 2)

out <- transmute(turnover_richness_HDS_m_tidy,
    Term = term,
    Estimate = round(estimate, digits = 3),
    `P-value` = p.value %>%
        round(digits = 3) %>%
        format(scientific = FALSE) %>%
        ifelse(. == "0.000",
               "< 0.001", 
               .)
)
out$Term <- c(
    "Intercept",
    "$log(\\overline{S_{QDS}} + 1)$", "$\\overline{J_{QDS}}$", "SWAFR",
    "$log(\\overline{S_{QDS}} + 1) \\times$ SWAFR",
    "$\\overline{J_{QDS}} \\times$ SWAFR"
)

knitr::kable(out, align = c("l", "r", "r"), caption = "(ref:full-model-table)")

```

(ref:full-model-table) Estimated regression coefficients and significances ($P$-value) following multiple linear regression of HDS richness ($S_{HDS}$) against the mean QDS richness ($\overline{S_{QDS}}$) and turnover ($\overline{J_{QDS}}$; Jaccards distance) within a given HDS, of the form $S_{HDS} \sim \overline{S_{QDS}} + \overline{J_{QDS}} + SWAFR + \overline{S_{QDS}} \times$ SWAFR $+ \overline{J_{QDS}} \times$ SWAFR. The GCFR was fit as the baseline, hence the SWAFR represents the categorical term here. This was model was better fitting than a similar model without a region category ($\Delta AIC =$ ", betterness_AIC, "). Note, this model does not represent those curves plot in Figure \ref{full_model_table} (there, the curves are from simple linear regressions of the variables in each panel, separated by region).

## Figures {-}

```{r roughness_violins, fig.width=6, fig.height=6, fig.cap="\\label{roughness_violins}Violin-plots of the distribution of roughness values (Z-scaled) for nine environmental variables in the GCFR and SWAFR, presented at $0.05 \\textdegree$ and $0.75 \\textdegree$ (= 3QDS) square cell scales. Roughness values were calculated following Equation \\ref{eqn1}. Points represent the median of each distribution. Violin-plots were constructed with Gaussian distributions on data, with bandwidth following Silverman's 'rule of thumb' (\\ref{Silverman1986}). Roughness values were found to be generally greater in the GCFR in all cases, unless marked as non-significant (NS), following Mann-Whitney U tests ($P < 0.05$)."}

test_results_summary %<>%
    gather(resolution, sig, -variable) %>%
    filter(resolution %in% c("0.05 x 0.05",
                             "0.75 x 0.75")) %>%
    mutate(sig = ifelse(sig,
                        "",
                        "NS"),
           region = "GCFR") %>%
    mutate(region = ifelse(region == "GCFR",
                           "Cape",
                           "SWA"))
test_results_summary <- data_for_violin_plot %>%
    group_by(variable) %>% 
    summarise(y = 0.7 * max(z_roughness)) %>%
    full_join(test_results_summary)
test_results_summary$variable %<>% factor(levels = var_names)

test_results_CLES_for_plot %<>%
    mutate(resolution = ifelse(resolution == 0.05,
                               "0.05 x 0.05",
                               ifelse(resolution == 0.25,
                                      "0.25 x 0.25",
                                      ifelse(resolution == 0.50,
                                             "0.50 x 0.50",
                                             ifelse(resolution == 0.75,
                                                    "0.75 x 0.75",
                                                    NA)))))
test_results_CLES_for_plot <- data_for_violin_plot %>%
    group_by(variable) %>% 
    summarise(y = 0.9 * max(z_roughness)) %>%
    full_join(test_results_CLES_for_plot)
test_results_CLES_for_plot %<>%
    # Convert from CLES of SWAFR - GCFR > 0 to GCFR - SWAFR > 0
    # (i.e. to now show what proprtion of pairs the Cape is greater for)
    mutate(CLES = 1 - CLES) %>%
    # Now round and format
    mutate(CLES = round(CLES, digits = 2))
test_results_CLES_for_plot$variable %<>% factor(levels = var_names)

data_for_violin_plot %<>%
    mutate(region = ifelse(region == "GCFR",
                           "Cape",
                           "SWA"))
data_for_violin_plot$variable %<>% factor(levels = var_names)

panel_a <- data_for_violin_plot %>%
    filter(resolution %in% c("0.05 x 0.05",
                             "0.75 x 0.75"),
           variable %in% c("Elevation",
                           "MAP",
                           "PDQ",
                           "Surface T",
                           "NDVI")) %>%
    ggplot(aes(region, z_roughness, col = region)) +
    scale_color_discrete(name = "Region") +
    geom_violin() +
    ylab("Z(roughness)") +
    stat_summary(geom = "point", fun.y = median) +
    facet_grid(variable ~ resolution, scales = "free_y") +
    # Label significances (Mann-Whitney U)
    geom_text(data = test_results_summary %>%
                  filter(resolution %in% c("0.05 x 0.05",
                                           "0.75 x 0.75"),
                         variable %in% c("Elevation",
                                         "MAP",
                                         "PDQ",
                                         "Surface T",
                                         "NDVI")),
              aes(y = y, label = sig),
              x = 1.5,
              col = "grey25") +
    # Label CLES
    geom_text(data = test_results_CLES_for_plot %>%
                  filter(resolution %in% c("0.05 x 0.05",
                                           "0.75 x 0.75"),
                         variable %in% c("Elevation",
                                         "MAP",
                                         "PDQ",
                                         "Surface T",
                                         "NDVI")),
              aes(y = y, label = CLES),
              x = 1.5,
              col = "grey25") +
    theme_bw() +
    theme(strip.background = element_blank(),
          panel.grid = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_blank())
    
panel_b <- data_for_violin_plot %>%
    filter(resolution %in% c("0.05 x 0.05",
                             "0.75 x 0.75"),
           variable %in% c("CEC",
                           "Clay",
                           "Soil C",
                           "pH")) %>%
    ggplot(aes(region, z_roughness, col = region)) +
    geom_violin() +
    stat_summary(geom = "point", fun.y = median) +
    facet_grid(variable ~ resolution, scales = "free_y") +
    # Label significances (Mann-Whitney U)
    geom_text(data = test_results_summary %>%
                  filter(resolution %in% c("0.05 x 0.05",
                                           "0.75 x 0.75"),
                         variable %in% c("CEC",
                                         "Clay",
                                         "Soil C",
                                         "pH")),
              aes(y = y, label = sig),
              x = 1.5,
              col = "grey25") +
    # Label CLES
    geom_text(data = test_results_CLES_for_plot %>%
                  filter(resolution %in% c("0.05 x 0.05",
                                           "0.75 x 0.75"),
                         variable %in% c("CEC",
                                         "Clay",
                                         "Soil C",
                                         "pH")),
              aes(y = y, label = CLES),
              x = 1.5,
              col = "grey25") +
    theme_bw() +
    theme(legend.position = "none", 
          strip.background = element_blank(),
          panel.grid = element_blank(),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_blank())

region_legend <- 
    gridExtra::arrangeGrob(panel_a)[[1]][[1]]$grobs[[37]]
panel_a <- panel_a + theme(legend.position = "none")

panel_b <- cowplot::plot_grid(
    panel_b, region_legend, 
    nrow = 2, rel_heights = c(4, 0.9)
)
cowplot::plot_grid(
    panel_a, panel_b, 
    nrow = 1, rel_widths = c(1, 0.9),
    labels = c("A", "B")
)

```

```{r roughness_IQ95R, fig.cap="\\label{roughness_IQ95R}Scatter-plots of the size of the 95%-to-5% and 99%-to-1% interquantile ranges ($IQ_{0.95}R$ and $IQ_{0.99}$ respectively, as keyed) of Z-scaled roughness values (Equation \\ref{eqn1}) against spatial resolution (cells as $0.05 \\textdegree$ to $0.75 \\textdegree$ squares (=3QDS)), for the GCFR (red) and SWAFR (blue). Lines connect points for illustration."}
# Plot GCFR vs SWAFR 95%-interquantile ranges ~ scale
IQ95R_data$variable %<>% factor(levels = var_names)
IQ95R_data %<>%
    mutate(region = ifelse(region == "GCFR",
                           "Cape",
                           "SWA"))
ggplot(IQ95R_data,
       aes(resolution, IXR,
           col = region,
           alpha = quantile,
           group = paste(variable, region, quantile))) +
    geom_point() +
    geom_path() +
    labs(x = "Resolution",
         y = "IQuR") +
         #y = expression(paste(
         #    "IQ"[0.95], "R   or   IQ"[0.99], "R"
         #))) +
    facet_wrap(~ variable) +
    scale_color_discrete(name = "Region") +
    scale_alpha_continuous(name = "Quantile",
                           range = c(1.00, 0.40),
                           breaks = c(0.95, 0.99)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 60, hjust = 1),
          strip.background = element_blank(),
          panel.grid = element_blank())
```

```{r turnover_vs_geodist, fig.width=4, fig.height=3, eval=FALSE, fig.cap="\\label{turnover_vs_geodist}Scatter-plot species turnover (as Jaccards distance) between cells against the geographic distance (m) between them, from both regions (coloured as keyed). Species turnover was calculated for all possible pairs of cells, but only the turnover values for a random 5000 pairs in each region have been plotted, for clarity. Fitted lines represent the 5%-quantile regressions of turnover as a function of log-distance for each region. Following a single 5%-quantile regression of turnover as a function of log-distance with region as a categorical variable, a significant interaction between distance and region was found ($P < 0.05$), such that the SWAFR negatively impacted the distance slope term."}

#turnover_geodist_betw_cells_df <- rbind(
#    cbind(rank = "species", species_turnover_geodist_betw_cells_df),
#    cbind(rank = "genus",   genus_turnover_geodist_betw_cells_df),
#    cbind(rank = "family",  family_turnover_geodist_betw_cells_df)
#)

pink <- scales::hue_pal()(2)[[1]]
dark_pink <- "#D8564D"
bluu <- scales::hue_pal()(2)[[2]]
dark_bluu <- "#009FA4"

turnover_geodist_betw_cells_df$region %<>% factor(levels = c("SWAFR", "GCFR"))

scatter_plot <- turnover_geodist_betw_cells_df %>%
    group_by(region, rank) %>%
    sample_n(5000) %>%
    ggplot() +
    geom_point(aes(geodist, turnover, col = region), alpha = 0.25) +
    labs(x = "Distance between cells (m)", 
         y = "Turnover (Jaccards distance)") +
    scale_colour_manual(name = "Region",
                        values = c(bluu, pink)) +
    facet_grid(~ rank) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position = c(0.5, 0.25))

rq_fits_added <- scatter_plot +
    geom_quantile(data = turnover_geodist_betw_cells_df %>%
                      filter(region == "GCFR"),
                  aes(geodist, turnover),
                  col = dark_pink, size = 1,
                  quantiles = 0.05) +#,
                  #formula = y ~ log(x)) +
    geom_quantile(data = turnover_geodist_betw_cells_df %>%
                      filter(region == "SWAFR"),
                  aes(geodist, turnover),
                  col = dark_bluu, size = 1,
                  quantiles = 0.05)#,
                  #formula = y ~ log(x))

plot(rq_fits_added)

```

```{r rq_turnover_vs_geodist, results = "asis",eval=FALSE}

species_turnover_geodist_m_tidy <- 
    cbind(rank = "species", broom::tidy(species_turnover_geodist_m))
genus_turnover_geodist_m_tidy <-
    cbind(rank = "genus",   broom::tidy(genus_turnover_geodist_m))
family_turnover_geodist_m_tidy <- 
    cbind(rank = "family",  broom::tidy(family_turnover_geodist_m))

CI_to_P <- function(est, u, l, t = 1.96) {
    # Based on <http://www.bmj.com/content/343/bmj.d2304>
    SE <- (u - l) / (2 * t)
    Z <- est / SE
    P <- exp(
        (-0.717 * Z) +
        (-0.416 * (Z ^ 2))
    )
    return(P)
}

species_out <- species_turnover_geodist_m_tidy %>%
    mutate(term = term,
           l    = conf.low,
           est  = estimate,
           u    = conf.high) %>%
    mutate(P = CI_to_P(est, u, l)) %>%
    dplyr::select(rank, term, est, P)

genus_out <- genus_turnover_geodist_m_tidy %>%
    mutate(term = term,
           l    = conf.low,
           est  = estimate,
           u    = conf.high) %>%
    mutate(P = CI_to_P(est, u, l)) %>%
    dplyr::select(rank, term, est, P)

family_out <- family_turnover_geodist_m_tidy %>%
    mutate(term = term,
           l    = conf.low,
           est  = estimate,
           u    = conf.high) %>%
    mutate(P = CI_to_P(est, u, l)) %>%
    dplyr::select(rank, term, est, P)

out <- rbind(species_out, genus_out, family_out)
out

#out %<>% dplyr::select(term, est)

#knitr::kable(out, caption = "\\label{rq_turnover_vs_geodist}$T_{ij} \\sim log(D_{ij}) + Region$")

```

```{r gamma_vs_alpha_beta, fig.width=8, fig.height=4,eval=FALSE, fig.cap="\\label{gamma_vs_alpha_beta}Scatter-plots of HDS-scale species richness against the average QDS-scale richness in a given HDS (left), and the average species turnover (Jaccards distance) between QDS in a given HDS (right). Curves represent simples linear regressions of HDS richness against the two respective independent variables (note, mean QDS richness was $log(x + 1)$-transformed), separately for each region, for illustration of the two regions' differences. The dashed horizontal line indicates HDS richness of 1500 species [discussed in text]."}

gamma_vs_alpha_plot <- 
    ggplot(gamma_beta_alpha,
           aes(avg_QDS_richness, HDS_richness, col = region)) +
    ylim(0, 3000) +
    xlim(0, 12500) +
    geom_point() +
    # Log t/form to normalise avg_QDS_richness scores
    geom_smooth(formula = y ~ log(x + 1), method = "lm") +
    geom_hline(yintercept = 1500, lty = "dashed") +
    labs(x = "Mean QDS richness",
         #x = expression(paste(bar("S")["QDS"])),
         y = "HDS richness") +
         #y = expression(paste("S"["HDS"]))) +
    scale_color_discrete(name = "Region") +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position = c(0.75, 0.25))
gamma_vs_beta_plot <-
    ggplot(gamma_beta_alpha,
           aes(avg_QDS_turnover, HDS_richness, col = region)) +
    ylim(0, 3000) +
    geom_point() +
    geom_smooth(formula = y ~ x, method = "lm") +
    geom_hline(yintercept = 1500, lty = "dashed") +
    labs(x = "Mean QDS turnover") +
         #x = expression(paste(bar("T")["QDS"]))) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          legend.position = "none",
          axis.text.y = element_blank(),
          axis.title.y = element_blank())

# Plot 2 panels + legend
cowplot::plot_grid(
    gamma_vs_alpha_plot, gamma_vs_beta_plot,
    nrow = 1, rel_widths = c(1, 0.9)
)

# No longer need code below (because of legend inset now)

# Get legend (modified from <https://stackoverflow.com/questions/12539348/ggplot-separate-legend-and-plot>)

#gg_legend<-function(a_ggplot){
#    tmp <- ggplot_gtable(ggplot_build(a_ggplot))
#    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
#    legend <- tmp$grobs[[leg]]
#    legend
#}
#region_legend <- 
#    gg_legend(gamma_vs_alpha_plot + theme(legend.position = "right"))

```
